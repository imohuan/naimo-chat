# 工具调用流转发修复总结

## 问题描述

在工具调用场景下，后端执行工具后会发送第二次请求到 LLM，但第二次请求的流输出没有被正确转发到前端的 SSE 连接中。主要问题包括：

1. **前端过早关闭连接**：前端在收到 `message_complete` 或 `session_end` 事件后立即关闭了 SSE 连接，导致无法接收工具执行后的第二次请求流输出
2. **后端会话过早关闭**：后端在第一次请求完成后立即关闭会话，没有给工具执行和第二次请求留出时间
3. **事件格式问题**：第二次请求的流事件格式可能不正确，导致无法正确转发

## 修复内容

### 一、后端修复

#### 1. `packages/backend/src/middleware/usageCacheMiddleware.js`

**主要修改：**

- **修复事件格式**：在 `sendToolResultToModel` 函数中，确保转发的事件包含正确的 `event` 和 `data` 字段

  ```javascript
  const eventToEnqueue = {
    event: value.event || (value.data?.type ? value.data.type : "message"),
    data: value.data || value,
  };
  ```

- **添加 `tool:continue_complete` 事件**：当第二次请求完成时，发送此事件通知前端可以关闭连接

  ```javascript
  if (
    value.event === "message_complete" ||
    (value.data && value.data.type === "message_complete")
  ) {
    receivedMessageComplete = true;
    safeEnqueue(controller, {
      event: "tool:continue_complete",
      data: {
        type: "tool:continue_complete",
        timestamp: new Date().toISOString(),
      },
    });
  }
  ```

- **增强调试日志**：添加详细的日志输出，便于追踪工具执行和第二次请求的流程

  - 记录工具消息数量和待执行工具数量
  - 记录新请求的发送和响应状态
  - 记录转发的事件数量和详细信息

- **改进错误处理**：在流读取过程中添加更完善的错误处理，包括背压控制和流关闭检测

#### 2. `packages/backend/src/conversations/router.js`

**主要修改：**

- **延迟关闭会话**：将会话关闭延迟从 1 秒增加到 3 秒，给工具执行和第二次请求留出时间

  ```javascript
  setTimeout(() => {
    const session = getSession(requestId);
    if (session && !session.closed) {
      closeSession(requestId);
    }
  }, 3000); // 延迟 3 秒，给工具执行和第二次请求留出时间
  ```

- **添加会话状态检查**：在关闭会话前检查会话是否仍然存在且未关闭

### 二、前端修复

#### 1. `packages/frontend/src/views/LlmDashboard/Chat/hooks/useSSEStream.ts`

**主要修改：**

- **延迟关闭连接逻辑**：

  - 添加 `hasToolCalls` 标记，跟踪是否有工具调用
  - 添加 `messageCompleteCount` 计数器，跟踪收到的 `message_complete` 事件数量
  - 在收到第一个 `message_complete` 时，如果有工具调用，不立即关闭连接
  - 在收到第二个 `message_complete` 或 `tool:continue_complete` 时，才关闭连接

  ```typescript
  case "message_complete":
    messageCompleteCount++;
    isCompleted = true;
    callbacks.onComplete?.();

    if (hasToolCalls) {
      if (messageCompleteCount === 1) {
        // 第一个 message_complete：第一次请求完成，工具调用开始执行
        console.log(`[useSSEStream] 检测到工具调用，等待工具执行完成和后续流输出`);
        // 不立即关闭连接，等待第二次请求完成
      } else if (messageCompleteCount === 2) {
        // 第二个 message_complete：工具执行后的第二次请求完成
        console.log(`[useSSEStream] 工具执行后的第二次请求完成，关闭连接`);
        disconnect();
      }
    } else {
      // 没有工具调用，立即关闭连接
      disconnect();
    }
    break;
  ```

- **处理 `session_end` 事件**：即使收到 `session_end` 事件，如果有工具调用，也不立即关闭连接

  ```typescript
  case "session_end":
    isCompleted = true;

    if (hasToolCalls) {
      console.log(`[useSSEStream] 检测到工具调用，即使收到 session_end 也等待工具执行完成和后续流输出`);
      // 不立即关闭连接，等待第二个 message_complete 或 tool:continue_complete 事件
    } else {
      disconnect();
    }
    break;
  ```

- **添加 `tool:continue_complete` 事件处理**：

  ```typescript
  case "tool:continue_complete":
    // 工具执行后的第二次请求完成
    console.log(`[useSSEStream] 工具执行后的第二次请求完成，关闭连接`);
    if (hasToolCalls) {
      disconnect();
    }
    break;
  ```

- **工具调用状态跟踪**：
  - 在 `content_block_start` 事件中检测工具调用，设置 `hasToolCalls = true`
  - 在 `tool:result` 和 `tool:error` 事件中更新 `pendingToolResults` 计数器

#### 2. `packages/frontend/src/views/LlmDashboard/Chat/types.ts`

**主要修改：**

- **添加新的 SSE 事件类型**：
  ```typescript
  export type SSEEventType =
    | "tool:result"
    | "tool:error"
    | "tool:continue_error"
    | "tool:continue_complete"
    | ...
  ```

#### 3. `packages/frontend/src/views/LlmDashboard/Chat/hooks/useConversation.ts`

**主要修改：**

- **修复未使用参数警告**：移除 `onToolResult` 和 `onToolError` 回调中未使用的 `tool_name` 参数

## 工作流程

修复后的完整工作流程：

1. **第一次请求**：

   - 用户发送消息 → 后端处理 → 返回 SSE 流
   - 前端接收工具调用事件（`content_block_start`, `content_block_delta`, `content_block_stop`）
   - 后端异步执行工具，发送 `tool:result` 或 `tool:error` 事件
   - 第一次请求完成，发送 `message_complete` 事件

2. **工具执行**：

   - 后端执行工具（异步，不阻塞事件传递）
   - 工具执行完成后，发送 `tool:result` 或 `tool:error` 事件给前端
   - 前端更新工具调用状态

3. **第二次请求**：

   - 后端在收到 `message_delta` 且所有工具执行完成后，发送第二次请求到 LLM
   - 后端转发第二次请求的所有流事件到前端
   - 第二次请求完成，发送 `message_complete` 事件
   - 后端发送 `tool:continue_complete` 事件

4. **连接关闭**：
   - 前端收到第二个 `message_complete` 或 `tool:continue_complete` 事件后，关闭连接
   - 即使收到 `session_end` 事件，如果有工具调用，也会等待上述事件

## 关键改进点

1. **事件格式标准化**：确保所有转发的事件都包含正确的 `event` 和 `data` 字段
2. **连接生命周期管理**：前端根据工具调用状态智能管理连接生命周期
3. **错误处理增强**：添加了更完善的错误处理和调试日志
4. **异步处理优化**：工具执行和第二次请求都是异步处理，不阻塞事件传递

## 测试建议

1. **工具调用测试**：

   - 发送包含工具调用的消息
   - 验证工具调用事件是否正确显示
   - 验证工具执行结果是否正确显示
   - 验证第二次请求的流输出是否正确显示

2. **连接管理测试**：

   - 验证在工具调用场景下，连接不会过早关闭
   - 验证在没有工具调用时，连接正常关闭
   - 验证 `session_end` 事件不会导致连接过早关闭

3. **错误处理测试**：
   - 测试工具执行失败的情况
   - 测试第二次请求失败的情况
   - 验证错误事件是否正确显示

## 相关文件

- `packages/backend/src/middleware/usageCacheMiddleware.js` - 后端工具调用处理中间件
- `packages/backend/src/conversations/router.js` - 后端路由处理
- `packages/frontend/src/views/LlmDashboard/Chat/hooks/useSSEStream.ts` - 前端 SSE 流处理
- `packages/frontend/src/views/LlmDashboard/Chat/types.ts` - 前端类型定义
- `packages/frontend/src/views/LlmDashboard/Chat/hooks/useConversation.ts` - 前端对话处理

## 注意事项

1. **会话关闭延迟**：后端会话关闭延迟设置为 3 秒，如果工具执行时间较长，可能需要调整
2. **事件格式一致性**：确保所有转发的事件都遵循相同的格式规范
3. **调试日志**：生产环境可能需要移除或减少调试日志输出
4. **错误处理**：确保所有错误情况都有适当的处理和用户提示

## 后续优化建议

1. **动态延迟调整**：根据工具执行时间动态调整会话关闭延迟
2. **重连机制**：如果连接意外关闭，考虑添加重连机制
3. **性能优化**：优化大量工具调用场景下的性能
4. **监控和日志**：添加更完善的监控和日志系统
