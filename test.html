<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gemini API 控制台</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- VueUse -->
  <script src="https://unpkg.com/@vueuse/shared"></script>
  <script src="https://unpkg.com/@vueuse/core"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background-color: #0f172a;
    }

    .glass-panel {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #334155;
      border-radius: 10px;
    }

    .typing-dot {
      animation: typing 1.4s infinite;
    }

    @keyframes typing {

      0%,
      100% {
        opacity: 0.2;
      }

      50% {
        opacity: 1;
      }
    }
  </style>
</head>

<body class="text-slate-200">
  <div id="app" class="h-screen flex flex-col overflow-hidden">
    <!-- 导航栏 -->
    <nav class="h-16 flex items-center justify-between px-6 border-b border-slate-800 glass-panel shrink-0">
      <div class="flex items-center space-x-3">
        <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/20">
          <i data-lucide="sparkles" class="w-5 h-5 text-white"></i>
        </div>
        <h1 class="text-xl font-bold tracking-tight text-white">Gemini Pro <span
            class="text-indigo-400 font-medium text-sm">Lab</span></h1>
      </div>

      <div class="flex items-center space-x-4">
        <div class="relative flex items-center">
          <i data-lucide="key" class="w-4 h-4 absolute left-3 text-slate-400"></i>
          <input v-model="apiKey" type="password" placeholder="输入你的 API Key..."
            class="pl-10 pr-4 py-2 bg-slate-900/50 border border-slate-700 rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500/50 w-64 transition-all">
        </div>
        <button @click="showSettings = !showSettings" class="p-2 hover:bg-slate-800 rounded-full transition-colors">
          <i data-lucide="settings" class="w-5 h-5 text-slate-400"></i>
        </button>
      </div>
    </nav>

    <main class="flex-1 flex overflow-hidden">
      <!-- 侧边栏设置 -->
      <aside v-if="showSettings"
        class="w-80 border-r border-slate-800 p-6 flex flex-col space-y-6 glass-panel overflow-y-auto custom-scrollbar">
        <div>
          <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3 block">选择模型</label>
          <div class="space-y-2">
            <button v-for="m in models" :key="m.id" @click="selectedModel = m.id"
              class="w-full text-left px-4 py-3 rounded-xl border transition-all duration-200"
              :class="selectedModel === m.id ? 'bg-indigo-600/10 border-indigo-500 text-indigo-400' : 'bg-slate-900/40 border-slate-800 hover:border-slate-700'">
              <div class="font-medium text-sm text-slate-100">{{ m.name }}</div>
              <div class="text-[10px] text-slate-500 mt-1 uppercase">{{ m.id }}</div>
            </button>
          </div>
        </div>

        <div class="space-y-4">
          <label class="text-xs font-semibold text-slate-400 uppercase tracking-wider block">生成参数</label>

          <div class="space-y-2">
            <div class="flex justify-between text-xs">
              <span class="text-slate-400">Temperature (温度)</span>
              <span class="text-indigo-400">{{ temperature }}</span>
            </div>
            <input type="range" v-model="temperature" min="0" max="2" step="0.1"
              class="w-full h-1.5 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-indigo-500">
          </div>

          <div class="space-y-2">
            <div class="flex justify-between text-xs">
              <span class="text-slate-400">Max Output Tokens</span>
              <span class="text-indigo-400">{{ maxTokens }}</span>
            </div>
            <input type="range" v-model="maxTokens" min="100" max="8192" step="100"
              class="w-full h-1.5 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-indigo-500">
          </div>
        </div>

        <div class="pt-6 border-t border-slate-800">
          <button @click="clearHistory"
            class="w-full flex items-center justify-center space-x-2 px-4 py-2 text-sm text-red-400 hover:bg-red-500/10 rounded-lg transition-colors">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
            <span>清除所有对话</span>
          </button>
        </div>
      </aside>

      <!-- 对话主区域 -->
      <div class="flex-1 flex flex-col relative">
        <!-- 消息展示区 -->
        <div ref="chatContainer" class="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar">
          <div v-if="messages.length === 0"
            class="h-full flex flex-col items-center justify-center text-slate-500 space-y-4">
            <div class="w-16 h-16 bg-slate-800 rounded-3xl flex items-center justify-center">
              <i data-lucide="message-square" class="w-8 h-8 opacity-20"></i>
            </div>
            <p class="text-sm">开始一段智能对话，Gemini 为您服务</p>
          </div>

          <div v-for="(msg, index) in messages" :key="index"
            :class="['flex', msg.role === 'user' ? 'justify-end' : 'justify-start']">
            <div
              :class="['max-w-[80%] rounded-2xl px-4 py-3 shadow-sm transition-all', 
                            msg.role === 'user' ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-slate-800/80 border border-slate-700 text-slate-200 rounded-tl-none']">
              <div class="text-sm leading-relaxed whitespace-pre-wrap">{{ msg.content }}</div>
              <div v-if="msg.sources" class="mt-2 pt-2 border-t border-slate-700/50 flex flex-wrap gap-2">
                <a v-for="source in msg.sources" :key="source.uri" :href="source.uri" target="_blank"
                  class="text-[10px] bg-slate-900/50 px-2 py-0.5 rounded text-indigo-400 hover:underline">
                  {{ source.title || '来源' }}
                </a>
              </div>
            </div>
          </div>

          <!-- 等待态 -->
          <div v-if="loading" class="flex justify-start">
            <div class="bg-slate-800 border border-slate-700 rounded-2xl rounded-tl-none px-4 py-3 flex space-x-1">
              <div class="w-1.5 h-1.5 bg-slate-500 rounded-full typing-dot"></div>
              <div class="w-1.5 h-1.5 bg-slate-500 rounded-full typing-dot" style="animation-delay: 0.2s"></div>
              <div class="w-1.5 h-1.5 bg-slate-500 rounded-full typing-dot" style="animation-delay: 0.4s"></div>
            </div>
          </div>
        </div>

        <!-- 输入区 -->
        <div class="p-6 shrink-0">
          <div class="max-w-4xl mx-auto relative group">
            <div
              class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl blur opacity-20 group-focus-within:opacity-40 transition duration-300">
            </div>
            <div
              class="relative bg-slate-900 border border-slate-700 rounded-2xl overflow-hidden flex items-end p-2 pr-3">
              <textarea v-model="inputMessage" @keydown.enter.prevent="sendMessage"
                placeholder="输入消息，Shift + Enter 换行..."
                class="w-full bg-transparent border-none text-slate-100 p-3 max-h-48 focus:ring-0 resize-none text-sm"
                rows="1" ref="inputField"></textarea>
              <button @click="sendMessage" :disabled="!inputMessage.trim() || !apiKey || loading"
                class="ml-2 mb-1 p-2 bg-indigo-600 disabled:bg-slate-800 disabled:text-slate-600 text-white rounded-xl transition-all active:scale-95 shadow-lg shadow-indigo-600/20">
                <i data-lucide="send-horizontal" class="w-5 h-5"></i>
              </button>
            </div>
            <div class="mt-2 flex justify-between items-center px-2">
              <p v-if="!apiKey" class="text-[10px] text-red-400 flex items-center">
                <i data-lucide="alert-circle" class="w-3 h-3 mr-1"></i> 请先输入 API Key
              </p>
              <p v-else class="text-[10px] text-slate-500">按 Enter 发送</p>
              <p class="text-[10px] text-slate-500">{{ selectedModel }}</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Vue App Logic -->
  <script type="text/x-template" id="chat-app">
        <!-- Template included in the main body above -->
    </script>

  <script>
    const { createApp, ref, onMounted, nextTick, watch } = Vue;
    const { useStorage } = VueUse;

    // --- Hooks: Gemini API Logic ---
    function useGemini() {
      const loading = ref(false);
      const error = ref(null);

      const callGemini = async (config) => {
        const { apiKey, model, messages, temperature, maxTokens } = config;
        const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

        // 将历史消息转换为 Gemini 的 content 格式
        const contents = messages.map(m => ({
          role: m.role === 'user' ? 'user' : 'model',
          parts: [{ text: m.content }]
        }));

        const payload = {
          contents,
          generationConfig: {
            temperature: parseFloat(temperature),
            maxOutputTokens: parseInt(maxTokens)
          },
          tools: [{ "google_search": {} }] // 启用 Google 搜索增强
        };

        let lastError = null;
        for (let attempt = 0; attempt < 5; attempt++) {
          try {
            loading.value = true;
            const response = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(errorData.error?.message || '请求失败');
            }

            const data = await response.json();
            const candidate = data.candidates?.[0];
            const text = candidate?.content?.parts?.[0]?.text;
            const sources = candidate?.groundingMetadata?.groundingAttributions?.map(a => ({
              uri: a.web?.uri,
              title: a.web?.title
            }));

            return { text, sources };
          } catch (err) {
            lastError = err;
            const delay = Math.pow(2, attempt) * 1000;
            await new Promise(r => setTimeout(r, delay));
          } finally {
            loading.value = false;
          }
        }
        throw lastError;
      };

      return { callGemini, loading, error };
    }

    // --- App Component ---
    const App = {
      setup() {
        const apiKey = useStorage('gemini-api-key', '');
        const messages = useStorage('gemini-history', []);
        const inputMessage = ref('');
        const showSettings = ref(true);
        const selectedModel = ref('gemini-2.5-flash-preview-09-2025');
        const temperature = ref(0.7);
        const maxTokens = ref(2048);
        const chatContainer = ref(null);
        const inputField = ref(null);

        const models = [
          { id: 'gemini-3-flash-preview', name: 'Gemini 3 Flash' },
          { id: 'gemini-2.5-flash-preview-09-2025', name: 'Gemini 2.5 Flash' },
        ];

        const { callGemini, loading } = useGemini();

        const scrollToBottom = async () => {
          await nextTick();
          if (chatContainer.value) {
            chatContainer.value.scrollTop = chatContainer.value.scrollHeight;
          }
        };

        const sendMessage = async () => {
          if (!inputMessage.value.trim() || loading.value || !apiKey.value) return;

          const userContent = inputMessage.value.trim();
          messages.value.push({ role: 'user', content: userContent });
          inputMessage.value = '';

          await scrollToBottom();

          try {
            const result = await callGemini({
              apiKey: apiKey.value,
              model: selectedModel.value,
              messages: messages.value,
              temperature: temperature.value,
              maxTokens: maxTokens.value
            });

            messages.value.push({
              role: 'assistant',
              content: result.text,
              sources: result.sources
            });
          } catch (err) {
            messages.value.push({
              role: 'assistant',
              content: `❌ 出错了: ${err.message}`
            });
          } finally {
            await scrollToBottom();
            nextTick(() => inputField.value?.focus());
          }
        };

        const clearHistory = () => {
          if (confirm('确定要清除所有聊天记录吗？')) {
            messages.value = [];
          }
        };

        onMounted(() => {
          lucide.createIcons();
          scrollToBottom();
        });

        // 监听状态更新图标
        watch([messages, showSettings], () => {
          nextTick(() => lucide.createIcons());
        }, { deep: true });

        return {
          apiKey, messages, inputMessage, showSettings,
          selectedModel, temperature, maxTokens, models,
          loading, sendMessage, clearHistory, chatContainer, inputField
        };
      }
    };

    createApp(App).mount('#app');
  </script>
</body>

</html>