<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Claude 流式对话 · 对话/日志</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3.4.27/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
</head>

<body class="bg-slate-50 text-slate-900">
  <div id="app" class="min-h-screen w-full">
    <div class="max-w-6xl mx-auto px-4 py-6 space-y-6">
      <!-- Header -->
      <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <h1 class="text-xl font-semibold text-slate-900">Claude 流式演示</h1>
          <p class="text-sm text-slate-500">SSE /api/stream/:id · 模拟或真实 CLI</p>
        </div>
        <div class="flex items-center gap-2 text-sm">
          <span v-if="state.streamingId" class="px-3 py-1 rounded-full bg-slate-200 text-slate-700">
            streamingId: {{ state.streamingId }}
          </span>
          <span
            :class="['px-3 py-1 rounded-full text-xs font-medium', state.isStreaming ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-200 text-slate-700']">
            {{ state.isStreaming ? 'Streaming' : 'Idle' }}
          </span>
        </div>
      </header>

      <!-- Controls -->
      <section class="bg-white border border-slate-200 rounded-xl shadow-sm p-4 space-y-3">
        <div class="flex flex-col gap-2">
          <label class="text-sm font-medium text-slate-700">输入消息</label>
          <textarea v-model="state.message" rows="4"
            class="w-full rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500 px-3 py-2 text-sm"
            placeholder="例如：帮我规划一个任务，并修改代码"></textarea>
        </div>
        <div class="flex flex-wrap items-center gap-3 text-sm">
          <label class="inline-flex items-center gap-2 text-slate-700">
            <input type="checkbox" v-model="state.useMock"
              class="rounded border-slate-300 text-indigo-600 focus:ring-indigo-500">
            使用本地 mock
          </label>
          <button @click="startSession" :disabled="state.isStarting || !state.message.trim()"
            class="inline-flex items-center gap-2 px-4 py-2 rounded-lg text-white text-sm font-medium transition disabled:opacity-60 disabled:cursor-not-allowed"
            :class="state.isStarting ? 'bg-indigo-300' : 'bg-indigo-600 hover:bg-indigo-700'">
            <span v-if="state.isStarting">创建中...</span>
            <span v-else>开新会话（SSE）</span>
          </button>
          <span class="text-slate-500 truncate">{{ state.status }}</span>
        </div>
      </section>

      <!-- Tabs -->
      <section class="bg-white border border-slate-200 rounded-xl shadow-sm p-4 space-y-4">
        <div class="flex items-center gap-2 text-sm">
          <button @click="state.activeTab = 'chat'"
            :class="['px-3 py-1 rounded-md border', state.activeTab === 'chat' ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-700 border-slate-200']">对话</button>
          <button @click="state.activeTab = 'logs'"
            :class="['px-3 py-1 rounded-md border', state.activeTab === 'logs' ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-700 border-slate-200']">日志</button>
        </div>

        <!-- Chat Tab -->
        <div v-if="state.activeTab === 'chat'" class="grid gap-4 lg:grid-cols-3">
          <div class="lg:col-span-2">
            <div class="flex items-center justify-between mb-2">
              <h3 class="text-base font-semibold text-slate-800">对话</h3>
              <div class="flex gap-2 text-xs">
                <button @click="clearChat"
                  class="px-2 py-1 rounded bg-slate-100 text-slate-700 hover:bg-slate-200">清空</button>
              </div>
            </div>
            <div
              class="bg-slate-50 border border-slate-200 rounded-lg p-3 min-h-[320px] max-h-[620px] overflow-auto space-y-3">
              <template v-if="state.chat.length === 0">
                <div class="text-sm text-slate-500">等待事件...</div>
              </template>
              <template v-else>
                <div v-for="item in state.chat" :key="item.id" class="flex">
                  <!-- 用户气泡 -->
                  <div v-if="item.role === 'user'" class="ml-auto max-w-[85%] w-fit">
                    <div class="text-right text-xs text-slate-400 mb-1">{{ item.time }}</div>
                    <div
                      class="rounded-lg bg-indigo-600 text-white px-3 py-2 shadow-sm text-sm prose prose-sm max-w-none"
                      v-html="item.html"></div>
                  </div>

                  <!-- 助手/工具气泡 -->
                  <div v-else class="mr-auto max-w-[90%] w-fit">
                    <div class="text-left text-xs text-slate-400 mb-1 flex items-center gap-2">
                      <span class="font-medium text-slate-700">{{ item.label }}</span>
                      <span>{{ item.time }}</span>
                    </div>

                    <div v-if="item.kind === 'text'"
                      class="rounded-lg bg-white border border-slate-200 px-3 py-2 shadow-sm text-sm prose prose-sm max-w-none"
                      v-html="item.html"></div>

                    <div v-else-if="item.kind === 'thinking'"
                      class="rounded-lg bg-indigo-50 border border-indigo-100 px-3 py-2 shadow-sm text-sm text-indigo-800 italic whitespace-pre-wrap">
                      {{ item.text }}
                    </div>

                    <div v-else-if="item.kind === 'tool_use'"
                      class="rounded-lg bg-amber-50 border border-amber-200 px-3 py-2 shadow-sm text-sm space-y-1">
                      <div class="font-semibold text-amber-800">调用工具: {{ item.toolName }}</div>
                      <pre
                        class="bg-slate-900 text-slate-100 rounded p-2 text-xs whitespace-pre-wrap overflow-auto">{{ item.input }}</pre>
                    </div>

                    <div v-else-if="item.kind === 'tool_result'"
                      class="rounded-lg bg-emerald-50 border border-emerald-200 px-3 py-2 shadow-sm text-sm space-y-1">
                      <div class="font-semibold text-emerald-800">工具结果: {{ item.toolName || 'tool_result' }}</div>
                      <pre
                        class="bg-emerald-900/70 text-emerald-50 rounded p-2 text-xs whitespace-pre-wrap overflow-auto">{{ item.output }}</pre>
                      <div v-if="item.isError" class="text-red-600 text-xs">标记为错误</div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- Sidebar: 任务 & 工具摘要 -->
          <div class="space-y-4">
            <div class="bg-white border border-slate-200 rounded-lg p-3 space-y-2">
              <div class="flex items-center justify-between">
                <h4 class="text-sm font-semibold text-slate-800">任务列表</h4>
                <span class="text-xs text-slate-500">{{ state.tasks.length }} 条</span>
              </div>
              <div class="space-y-2 max-h-[260px] overflow-auto pr-1">
                <div v-if="state.tasks.length === 0"
                  class="text-sm text-slate-500 bg-slate-50 border border-dashed border-slate-200 rounded-lg p-3">暂无任务事件
                </div>
                <div v-for="task in state.tasks" :key="task.timestamp + task.title"
                  class="border border-slate-200 rounded-lg p-2 space-y-1">
                  <div class="flex items-center justify-between">
                    <p class="text-sm font-medium text-slate-800 truncate">{{ task.title || '任务' }}</p>
                    <span :class="['text-xs px-2 py-0.5 rounded-full font-medium',
                      task.status === 'done' ? 'bg-emerald-100 text-emerald-700' :
                      task.status === 'progress' ? 'bg-amber-100 text-amber-700' :
                      task.status === 'started' ? 'bg-indigo-100 text-indigo-700' :
                      'bg-slate-100 text-slate-600']">
                      {{ task.status || 'info' }}
                    </span>
                  </div>
                  <p class="text-xs text-slate-500">{{ task.detail || '无描述' }}</p>
                  <div class="flex items-center justify-between text-xs text-slate-400">
                    <span>{{ formatTime(task.timestamp) }}</span>
                    <span v-if="task.progress !== undefined">进度 {{ task.progress }}%</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-lg p-3 space-y-2">
              <div class="flex items-center justify-between">
                <h4 class="text-sm font-semibold text-slate-800">工具摘要</h4>
                <button @click="state.toolUses = []" class="text-xs text-indigo-600 hover:text-indigo-700">清空</button>
              </div>
              <div class="space-y-2 max-h-[260px] overflow-auto pr-1">
                <div v-if="state.toolUses.length === 0" class="text-sm text-slate-500">暂无工具调用</div>
                <div v-for="tool in state.toolUses" :key="tool.id"
                  class="border border-slate-200 rounded-md p-2 text-xs space-y-1">
                  <div class="flex items-center justify-between">
                    <span class="font-semibold text-amber-700">{{ tool.name }}</span>
                    <span class="text-slate-500">{{ tool.time }}</span>
                  </div>
                  <div class="text-slate-800 break-words">输入: {{ tool.input }}</div>
                  <div v-if="tool.result" class="text-emerald-700 break-words">输出: {{ tool.result }}</div>
                  <div v-if="tool.isError" class="text-red-600">标记为错误</div>
                </div>
              </div>
            </div>

            <div class="bg-white border border-slate-200 rounded-lg p-3 space-y-2">
              <div class="flex items-center justify-between">
                <h4 class="text-sm font-semibold text-slate-800">权限请求</h4>
                <div class="flex items-center gap-2 text-xs">
                  <button @click="fetchPermissions"
                    class="px-2 py-1 rounded bg-slate-100 text-slate-700 hover:bg-slate-200">刷新</button>
                </div>
              </div>
              <div v-if="state.permissionsError" class="text-xs text-red-600">{{ state.permissionsError }}</div>
              <div class="space-y-2 max-h-[260px] overflow-auto pr-1">
                <div v-if="state.permissionsLoading" class="text-sm text-slate-500">加载中...</div>
                <div v-else-if="state.permissions.length === 0" class="text-sm text-slate-500">暂无待审批</div>
                <div v-for="perm in state.permissions" :key="perm.id"
                  class="border border-slate-200 rounded-md p-2 text-xs space-y-1">
                  <div class="flex items-center justify-between">
                    <span class="font-semibold text-amber-700">{{ perm.toolName }}</span>
                    <span class="text-slate-500">{{ formatTime(perm.timestamp) }}</span>
                  </div>
                  <div class="text-slate-800 break-words">输入: {{ perm.toolInput }}</div>
                  <div class="flex items-center gap-2 text-[11px] text-slate-500">
                    <span>状态: {{ perm.status }}</span>
                    <span v-if="perm.streamingId">stream: {{ perm.streamingId }}</span>
                  </div>
                  <div class="space-y-1">
                    <label class="block text-[11px] text-slate-500">修改输入(可选)</label>
                    <textarea v-model="state.approvePayload[perm.id]" rows="2"
                      class="w-full border border-slate-200 rounded px-2 py-1 text-[11px] focus:outline-none focus:ring-1 focus:ring-indigo-500"></textarea>
                    <button @click="approvePermission(perm.id)"
                      class="w-full mt-1 px-2 py-1 rounded bg-emerald-600 text-white text-[11px] hover:bg-emerald-700">同意</button>
                  </div>
                  <div class="space-y-1">
                    <label class="block text-[11px] text-slate-500">拒绝原因(可选)</label>
                    <textarea v-model="state.denyPayload[perm.id]" rows="2"
                      class="w-full border border-slate-200 rounded px-2 py-1 text-[11px] focus:outline-none focus:ring-1 focus:ring-rose-500"></textarea>
                    <button @click="denyPermission(perm.id)"
                      class="w-full mt-1 px-2 py-1 rounded bg-rose-600 text-white text-[11px] hover:bg-rose-700">拒绝</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Logs Tab -->
        <div v-else class="w-full">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-base font-semibold text-slate-800">日志</h3>
            <button @click="state.rawEvents = []" class="text-xs text-indigo-600 hover:text-indigo-700">清空</button>
          </div>
          <div
            class="bg-slate-900 text-slate-100 rounded-lg p-3 text-xs whitespace-pre overflow-auto max-h-[720px] border border-slate-800">
            <div v-if="state.rawEvents.length === 0" class="text-slate-400">暂无事件</div>
            <div v-for="(evt, idx) in state.rawEvents" :key="idx" class="flex gap-2">
              <span class="text-slate-500 shrink-0">{{ evt.time }}</span>
              <span class="text-emerald-300 shrink-0">{{ evt.type }}</span>
              <code class="text-slate-100 break-all">{{ evt.payload }}</code>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    const { createApp, reactive, onBeforeUnmount } = Vue;

    createApp({
      setup() {
        const state = reactive({
          message: '创建一个HTML 代码， HTML中展示 文本 Hello world to ',
          useMock: true,
          status: '等待输入',
          streamingId: null,
          streamUrl: null,
          isStarting: false,
          isStreaming: false,
          evtSource: null,
          activeTab: 'chat',
          chat: [],
          tasks: [],
          toolUses: [],
          rawEvents: [],
          permissions: [],
          permissionsLoading: false,
          permissionsError: '',
          approvePayload: {},
          denyPayload: {},
        });

        const formatTime = (ts) => {
          if (!ts) return '';
          return new Date(ts).toLocaleTimeString();
        };

        const clearChat = () => {
          state.chat = [];
          state.toolUses = [];
        };

        const resetStreamData = () => {
          clearChat();
          state.tasks = [];
          state.rawEvents = [];
        };

        const stopStream = () => {
          if (state.evtSource) {
            state.evtSource.close();
            state.evtSource = null;
          }
          state.isStreaming = false;
        };

        const pushRaw = (type, payload) => {
          state.rawEvents.push({
            time: new Date().toLocaleTimeString(),
            type,
            payload: typeof payload === 'string' ? payload : JSON.stringify(payload),
          });
        };

        const upsertTask = (evt) => {
          const idx = state.tasks.findIndex(t => (t.title || '') === (evt.title || '') && (t.timestamp || '') === (evt.timestamp || ''));
          const item = {
            title: evt.title,
            detail: evt.detail || evt.message,
            status: evt.status,
            progress: evt.progress,
            timestamp: evt.timestamp || new Date().toISOString(),
          };
          if (idx >= 0) {
            state.tasks[idx] = { ...state.tasks[idx], ...item };
          } else {
            state.tasks.unshift(item);
          }
        };

        const addChatItem = (payload) => {
          state.chat.push(payload);
          if (state.chat.length > 300) state.chat.shift();
        };

        const fetchPermissions = async () => {
          state.permissionsLoading = true;
          state.permissionsError = '';
          try {
            const qs = state.streamingId ? `?streamingId=${encodeURIComponent(state.streamingId)}` : '';
            const res = await fetch(`/api/chat/permissions${qs}`);
            const data = await res.json();
            if (!res.ok) {
              state.permissionsError = data.error || res.statusText;
            } else {
              state.permissions = data.permissions || [];
            }
          } catch (e) {
            state.permissionsError = String(e);
          } finally {
            state.permissionsLoading = false;
          }
        };

        const approvePermission = async (id) => {
          const modifiedInput = state.approvePayload[id] || '';
          try {
            const res = await fetch(`/api/chat/permissions/${id}/decision`, {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ action: 'approve', modifiedInput: modifiedInput.trim() || undefined }),
            });
            const data = await res.json();
            if (!res.ok) {
              state.permissionsError = data.error || res.statusText;
            } else {
              await fetchPermissions();
            }
          } catch (e) {
            state.permissionsError = String(e);
          }
        };

        const denyPermission = async (id) => {
          const denyReason = state.denyPayload[id] || '';
          try {
            const res = await fetch(`/api/chat/permissions/${id}/decision`, {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ action: 'deny', denyReason: denyReason.trim() || undefined }),
            });
            const data = await res.json();
            if (!res.ok) {
              state.permissionsError = data.error || res.statusText;
            } else {
              await fetchPermissions();
            }
          } catch (e) {
            state.permissionsError = String(e);
          }
        };

        const upsertPermission = (perm) => {
          const idx = state.permissions.findIndex(p => p.id === perm.id);
          if (idx >= 0) {
            state.permissions[idx] = { ...state.permissions[idx], ...perm };
          } else {
            state.permissions.unshift(perm);
          }
        };

        const handleEvent = (evt) => {
          pushRaw(evt.type || 'raw', evt);

          switch (evt.type) {
            case 'system':
              if (evt.subtype === 'init') {
                state.status = `初始化中 · cwd=${evt.cwd || ''}`;
              }
              break;

            case 'task':
              upsertTask(evt);
              break;

            case 'content_block_delta':
              if (evt.delta?.text) {
                addChatItem({
                  id: `thinking-${Date.now()}-${Math.random()}`,
                  role: 'assistant',
                  kind: 'thinking',
                  label: '思维链增量',
                  text: evt.delta.text,
                  time: formatTime(evt.timestamp || new Date()),
                });
              }
              break;

            case 'message':
              if (Array.isArray(evt.content)) {
                evt.content.forEach((block) => {
                  if (block.type === 'text' && block.text) {
                    addChatItem({
                      id: `text-${Date.now()}-${Math.random()}`,
                      role: 'assistant',
                      kind: 'text',
                      label: '助手',
                      html: marked.parse(block.text),
                      time: formatTime(evt.timestamp || new Date()),
                    });
                  }
                  if (block.type === 'thinking' && block.thinking) {
                    addChatItem({
                      id: `thinking-${Date.now()}-${Math.random()}`,
                      role: 'assistant',
                      kind: 'thinking',
                      label: '思维链',
                      text: block.thinking,
                      time: formatTime(evt.timestamp || new Date()),
                    });
                  }
                  if (block.type === 'tool_use') {
                    // Auto-issue permission notify when a tool is invoked (simulating MCP approval prompt)
                    notifyPermission(block);
                    console.log(123);


                    const toolId = block.id || `tool-${Date.now()}-${Math.random()}`;
                    state.toolUses.unshift({
                      id: toolId,
                      name: block.name,
                      input: JSON.stringify(block.input, null, 2),
                      time: formatTime(evt.timestamp || new Date()),
                      result: null,
                      isError: false,
                    });
                    addChatItem({
                      id: `tool-${toolId}`,
                      role: 'assistant',
                      kind: 'tool_use',
                      label: '工具调用',
                      toolName: block.name,
                      input: JSON.stringify(block.input, null, 2),
                      time: formatTime(evt.timestamp || new Date()),
                    });
                  }
                });
              }
              break;

            case 'user':
              // tool_result blocks arrive as user message content
              if (Array.isArray(evt.message?.content)) {
                evt.message.content.forEach((block) => {
                  if (block.type === 'tool_result' && block.tool_use_id) {
                    const resText = typeof block.content === 'string'
                      ? block.content
                      : Array.isArray(block.content)
                        ? block.content.map(p => p.text || '').join('\n')
                        : JSON.stringify(block.content);

                    addChatItem({
                      id: `tool-result-${block.tool_use_id}-${Date.now()}`,
                      role: 'assistant',
                      kind: 'tool_result',
                      label: '工具结果',
                      toolName: block.tool_use_id,
                      output: resText,
                      isError: block.is_error,
                      time: formatTime(evt.timestamp || new Date()),
                    });

                    const idx = state.toolUses.findIndex(t => t.id === block.tool_use_id);
                    if (idx >= 0) {
                      state.toolUses[idx] = { ...state.toolUses[idx], result: resText, isError: block.is_error };
                    } else {
                      state.toolUses.unshift({
                        id: block.tool_use_id,
                        name: block.tool_use_id,
                        input: '',
                        result: resText,
                        time: formatTime(evt.timestamp || new Date()),
                        isError: block.is_error,
                      });
                    }
                  } else if (block.type === 'text' && block.text) {
                    // Plain user text (rare in this channel) treated as user message
                    addChatItem({
                      id: `user-${Date.now()}`,
                      role: 'user',
                      kind: 'text',
                      label: '用户',
                      html: marked.parse(block.text),
                      time: formatTime(evt.timestamp || new Date()),
                    });
                  }
                });
              }
              break;

            case 'error':
              state.status = `错误：${evt.stderr || evt.error || 'unknown'}`;
              upsertTask({ title: '错误', detail: state.status, status: 'error', timestamp: evt.timestamp });
              break;

            case 'process_end':
              state.status = `结束 code=${evt.code}`;
              state.isStreaming = false;
              stopStream();
              fetchPermissions();
              break;

            case 'permission_request':
              if (evt.permission) {
                upsertPermission(evt.permission);
              }
              break;

            case 'permission_decision':
              if (evt.permission) {
                upsertPermission(evt.permission);
              }
              break;

            default:
              if (evt.data) {
                addChatItem({
                  id: `raw-${Date.now()}-${Math.random()}`,
                  role: 'assistant',
                  kind: 'text',
                  label: '原始片段',
                  html: marked.parse(evt.data),
                  time: formatTime(evt.timestamp || new Date()),
                });
              }
          }
        };

        const startStream = (streamingId, url) => {
          stopStream();
          resetStreamData();
          state.streamingId = streamingId;
          state.streamUrl = url;
          state.isStreaming = true;
          state.status = 'SSE 连接中...';
          fetchPermissions();

          const es = new EventSource(url);
          state.evtSource = es;

          es.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              handleEvent(data);
            } catch (err) {
              pushRaw('raw', event.data);
            }
          };

          es.onerror = (err) => {
            state.status = 'SSE 连接出错';
            state.isStreaming = false;
            pushRaw('error', err);
          };
        };

        // Bridge: notify backend when tool_use happens (simulating MCP approval prompt)
        const notifyPermission = async (block) => {
          if (!block?.name) return;
          try {
            await fetch('/api/chat/permissions/notify', {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({
                toolName: block.name,
                toolInput: block.input,
                streamingId: state.streamingId || 'unknown'
              })
            });
          } catch (err) {
            console.error('notifyPermission failed', err);
          }
        };

        const startSession = async () => {
          const message = state.message.trim();
          if (!message) return;

          state.isStarting = true;
          state.status = '创建中...';
          // 先把用户输入展现在对话中
          addChatItem({
            id: `user-${Date.now()}`,
            role: 'user',
            kind: 'text',
            label: '用户',
            html: marked.parse(message),
            time: formatTime(new Date()),
          });

          try {
            const res = await fetch('/api/chat/start', {
              method: 'POST',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ message, mock: state.useMock }),
            });
            const data = await res.json();
            if (!res.ok) {
              state.status = `错误：${data.error || res.statusText}`;
              return;
            }
            state.status = `streamingId=${data.streamingId}`;
            startStream(data.streamingId, data.streamUrl);
          } catch (e) {
            state.status = `请求失败：${e}`;
          } finally {
            state.isStarting = false;
          }
        };

        onBeforeUnmount(() => stopStream());

        return {
          state,
          startSession,
          formatTime,
          clearChat,
          fetchPermissions,
          approvePermission,
          denyPermission,
          approvePayload: state.approvePayload,
          denyPayload: state.denyPayload,
        };
      },
    }).mount('#app');
  </script>
</body>

</html>