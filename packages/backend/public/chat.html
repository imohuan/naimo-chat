<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat UI</title>
  <link rel="icon" type="image/svg+xml" href="./vite.svg" />
  <!-- èµ„æºåŠ è½½ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
    }

    .custom-scrollbar::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
      border: 2px solid #f1f5f9;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    /* æ¶ˆæ¯åˆ—è¡¨ä¸“ç”¨æ»šåŠ¨æ¡æ ·å¼ */
    #chat-container::-webkit-scrollbar,
    .subagent-messages-container::-webkit-scrollbar {
      width: 10px;
    }

    #chat-container::-webkit-scrollbar-track,
    .subagent-messages-container::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }

    #chat-container::-webkit-scrollbar-thumb,
    .subagent-messages-container::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
      border: 2px solid #f1f5f9;
    }

    #chat-container::-webkit-scrollbar-thumb:hover,
    .subagent-messages-container::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .message-enter-active,
    .message-leave-active {
      transition: all 0.3s ease;
    }

    .message-enter-from {
      opacity: 0;
      transform: translateY(10px);
    }

    .tool-card {
      border-left: 3px solid #3b82f6;
    }

    .diff-added {
      background-color: #f0fdf4;
      border-left: 3px solid #22c55e;
    }

    .diff-removed {
      background-color: #fef2f2;
      border-left: 3px solid #ef4444;
    }

    pre {
      white-space: pre-wrap;
      word-break: break-all;
    }

    .tool-collapse-btn {
      transition: transform 0.2s ease;
    }

    .tool-collapsed .tool-collapse-btn {
      transform: rotate(-90deg);
    }

    /* Gemini-style Input Container */
    .input-container-gemini {
      display: flex;
      flex-direction: column;
      background: #f8f9fa;
      border: 1px solid #e8eaed;
      border-radius: 12px;
      padding: 12px 14px 10px 14px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: all 0.2s;
    }

    .input-container-gemini:focus-within {
      background: #ffffff;
      border-color: #d2d5da;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .preview-area-input {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .preview-area-input:empty {
      display: none;
    }

    .preview-wrapper-input {
      position: relative;
      display: inline-block;
    }

    .preview-item-input {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid #e2e8f0;
      display: block;
      background: #f8fafc;
      cursor: pointer;
    }

    .preview-close-input {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 2;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .preview-wrapper-input:hover .preview-close-input {
      opacity: 1;
    }

    .button-row-input {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 8px;
    }

    .add-btn-input {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: transparent;
      color: #5f6368;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 0.2s;
      flex-shrink: 0;
      border: none;
    }

    .add-btn-input:hover {
      background: #e8eaed;
    }

    .left-buttons-input {
      display: flex;
      align-items: center;
      gap: 10px;
    }


    .right-buttons-input {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .model-selector-input {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 14px;
      background: transparent;
      color: #202124;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: 0.2s;
      user-select: none;
    }

    .model-selector-input:hover {
      background: #e8eaed;
    }

    .model-dropdown-input {
      position: absolute;
      bottom: calc(100% + 8px);
      right: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      padding: 6px 0;
      min-width: 280px;
      display: none;
      z-index: 1000;
    }

    .model-dropdown-input.active {
      display: block;
    }

    .model-dropdown-header {
      padding: 10px 14px;
      font-size: 12px;
      color: #5f6368;
      font-weight: 500;
      border-bottom: 1px solid #e8eaed;
    }

    .model-option-input {
      padding: 10px 14px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: 0.2s;
    }

    .model-option-input:hover {
      background: #f8f9fa;
    }

    .model-option-content {
      flex: 1;
    }

    .model-option-title {
      font-size: 14px;
      font-weight: 500;
      color: #202124;
      margin-bottom: 2px;
    }

    .model-option-desc {
      font-size: 11px;
      color: #5f6368;
      line-height: 1.3;
    }

    .model-option-check {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #1967d2;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
    }

    .model-option-input.selected .model-option-check {
      opacity: 1;
    }

    /* CWD Selector Styles */
    .cwd-selector-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .cwd-input-container {
      position: relative;
      display: flex;
      align-items: center;
      border: 1px solid #dadce0;
      border-radius: 8px;
      background: transparent;
      transition: 0.2s;
      overflow: hidden;
    }

    .cwd-input-container:hover {
      border-color: #bdc1c6;
      background: #f8f9fa;
    }

    .cwd-input-container:focus-within {
      background: #ffffff;
      border-color: #d2d5da;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .cwd-icon {
      padding-left: 10px;
      color: #5f6368;
      font-size: 14px;
      flex-shrink: 0;
    }

    .cwd-input {
      width: 200px;
      padding: 4px 28px 4px 8px;
      border: none;
      background: transparent;
      color: #202124;
      font-size: 13px;
      outline: none;
    }

    .cwd-dropdown-icon {
      position: absolute;
      right: 8px;
      cursor: pointer;
      color: #5f6368;
      transition: transform 0.2s;
      flex-shrink: 0;
    }

    .cwd-dropdown-icon:hover {
      color: #202124;
    }

    .cwd-dropdown {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      padding: 6px 0;
      min-width: 300px;
      max-width: 500px;
      max-height: 300px;
      overflow-y: auto;
      display: none;
      z-index: 1000;
    }

    .cwd-dropdown.active {
      display: block;
    }

    .cwd-dropdown-empty {
      padding: 20px;
      text-align: center;
      color: #5f6368;
      font-size: 13px;
    }

    .cwd-option {
      padding: 10px 14px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: 0.2s;
    }

    .cwd-option:hover {
      background: #f8f9fa;
    }

    .cwd-option.selected {
      background: #e8f0fe;
    }

    .cwd-option-content {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #202124;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .cwd-option-icon {
      color: #5f6368;
      font-size: 13px;
      flex-shrink: 0;
    }

    .cwd-remove-btn {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: #5f6368;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: 0.2s;
      flex-shrink: 0;
    }

    .cwd-remove-btn:hover {
      background: #f1f3f4;
      color: #d93025;
    }

    .assistant-group {
      display: flex;
      gap: 1rem;
      max-width: 56rem;
      margin: 0 auto;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 0.75rem;
    }

    .assistant-group-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .assistant-text {
      color: #1e293b;
      line-height: 1.6;
    }

    /* Markdown æ ·å¼ä¿®å¤ */
    .assistant-text p {
      margin: 0.5rem 0;
    }

    .assistant-text ul,
    .assistant-text ol {
      margin: 0.75rem 0;
      padding-left: 1.5rem;
    }

    .assistant-text ul {
      list-style-type: disc;
    }

    .assistant-text ol {
      list-style-type: decimal;
    }

    .assistant-text li {
      margin: 0.25rem 0;
      padding-left: 0.25rem;
    }

    .assistant-text li::marker {
      color: #64748b;
    }

    .assistant-text h1 {
      font-size: 1.875rem;
      font-weight: 700;
      margin: 1.5rem 0 1rem 0;
      line-height: 1.2;
    }

    .assistant-text h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 1.25rem 0 0.75rem 0;
      line-height: 1.3;
    }

    .assistant-text h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 1rem 0 0.5rem 0;
      line-height: 1.4;
    }

    .assistant-text h4 {
      font-size: 1.125rem;
      font-weight: 600;
      margin: 0.875rem 0 0.5rem 0;
      line-height: 1.4;
    }

    .assistant-text h5 {
      font-size: 1rem;
      font-weight: 600;
      margin: 0.75rem 0 0.5rem 0;
      line-height: 1.5;
    }

    .assistant-text h6 {
      font-size: 0.875rem;
      font-weight: 600;
      margin: 0.75rem 0 0.5rem 0;
      line-height: 1.5;
    }

    .assistant-text blockquote {
      border-left: 4px solid #cbd5e1;
      padding-left: 1rem;
      margin: 1rem 0;
      color: #64748b;
      font-style: italic;
    }

    .assistant-text hr {
      border: none;
      border-top: 1px solid #e2e8f0;
      margin: 1.5rem 0;
    }

    .assistant-text a {
      color: #3b82f6;
      text-decoration: underline;
    }

    .assistant-text a:hover {
      color: #2563eb;
    }

    .assistant-text strong {
      font-weight: 600;
    }

    .assistant-text em {
      font-style: italic;
    }

    .assistant-text code {
      background: #e2e8f0;
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-size: 0.875em;
      font-family: 'Courier New', Courier, monospace;
    }

    .assistant-text pre {
      background: #f1f5f9;
      color: #1e293b;
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
      border: 1px solid #e2e8f0;
      margin: 1rem 0;
    }

    .assistant-text pre code {
      background: transparent;
      padding: 0;
      color: #1e293b;
      font-size: 0.875rem;
    }

    .assistant-text table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }

    .assistant-text table th,
    .assistant-text table td {
      border: 1px solid #e2e8f0;
      padding: 0.5rem 0.75rem;
      text-align: left;
    }

    .assistant-text table th {
      background: #f8fafc;
      font-weight: 600;
    }

    .assistant-text table tr:nth-child(even) {
      background: #f8fafc;
    }

    /* ç§»é™¤ space-y é€ æˆçš„é—´éš” */
    .space-y-3>*+* {
      margin-top: 0 !important;
    }

    .space-y-3>.w-full+.w-full {
      margin-top: 0.75rem !important;
    }

    /* è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†æ ·å¼ */
    .custom-dropdown {
      position: relative;
      width: 180px;
    }

    .dropdown-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      transition: all 0.2s;
      overflow: hidden;
      height: 38px;
    }

    .dropdown-header:hover {
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .dropdown-header.disabled {
      background: #f1f5f9;
      opacity: 0.6;
    }

    .dropdown-trigger {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 0.75rem;
      cursor: pointer;
      user-select: none;
      min-width: 0;
    }

    .dropdown-trigger.disabled {
      cursor: not-allowed;
    }

    .dropdown-trigger-text {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 0.875rem;
      color: #334155;
      font-weight: 500;
    }

    .dropdown-run-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 38px;
      height: 38px;
      background: #3b82f6;
      color: white;
      border-left: 1px solid rgba(255, 255, 255, 0.2);
      cursor: pointer;
      transition: background 0.2s;
      flex-shrink: 0;
    }

    .dropdown-run-btn:hover:not(.disabled) {
      background: #2563eb;
    }

    .dropdown-run-btn.disabled {
      background: #cbd5e1;
      cursor: not-allowed;
    }

    .dropdown-menu {
      position: absolute;
      top: calc(100% + 0.25rem);
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      max-height: 240px;
      overflow-y: auto;
      z-index: 50;
      animation: dropdown-fade-in 0.15s ease-out;
    }

    @keyframes dropdown-fade-in {
      from {
        opacity: 0;
        transform: translateY(-4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .dropdown-item-wrapper {
      display: flex;
      align-items: center;
      transition: background 0.15s;
      position: relative;
    }

    .dropdown-item-wrapper:hover {
      background: #f1f5f9;
    }

    .dropdown-item-wrapper.selected {
      background: #eff6ff;
    }

    .dropdown-item-wrapper.selected .dropdown-item {
      color: #2563eb;
      font-weight: 500;
    }

    .dropdown-item {
      flex: 1;
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      font-size: 0.875rem;
      color: #334155;
      min-width: 0;
    }

    .dropdown-delete-btn {
      padding: 0.25rem 0.5rem;
      cursor: pointer;
      color: #94a3b8;
      background: transparent;
      border: none;
      transition: color 0.15s;
      flex-shrink: 0;
      opacity: 0;
      font-size: 0.75rem;
    }

    .dropdown-item-wrapper:hover .dropdown-delete-btn {
      opacity: 1;
    }

    .dropdown-delete-btn:hover {
      color: #ef4444;
    }

    .dropdown-chevron {
      transition: transform 0.2s;
      font-size: 0.75rem;
      margin-left: 0.5rem;
      flex-shrink: 0;
    }

    .dropdown-chevron.open {
      transform: rotate(180deg);
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fade-in 0.2s ease-out;
    }

    @keyframes fade-in {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      animation: slide-up 0.2s ease-out;
    }

    @keyframes slide-up {
      from {
        transform: translateY(20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .save-events-btn {
      position: sticky;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .save-icon-btn {
      padding: 2px 4px;
      border-radius: 4px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .save-icon-btn:hover {
      background: rgba(59, 130, 246, 0.1);
    }

    /* Image Viewer - Full Screen */
    .image-viewer {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 99999;
      display: none;
      align-items: center;
      justify-content: center;
      user-select: none;
    }

    .image-viewer.active {
      display: flex;
    }

    .viewer-image-wrapper {
      max-width: 90%;
      max-height: 90%;
      cursor: grab;
      user-select: none;
    }

    .viewer-image-wrapper:active {
      cursor: grabbing;
    }

    .viewer-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      pointer-events: none;
      user-select: none;
    }

    .viewer-close {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: transparent;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100000;
    }

    .viewer-close:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .viewer-controls {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      padding: 8px 20px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .viewer-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: transparent;
      color: #202124;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
    }

    .viewer-btn:hover {
      background: #e8eaed;
    }

    .viewer-zoom-level {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 60px;
      font-size: 14px;
      font-weight: 500;
      color: #202124;
    }

    /* è‡ªåŠ¨åˆ·æ–°åŠ¨ç”» */
    @keyframes rotate {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .animate-spin {
      animation: rotate 1s linear infinite;
    }

    /* è‡ªåŠ¨åˆ·æ–°æ§åˆ¶é¢æ¿æ ·å¼ */
    .auto-refresh-panel {
      transition: all 0.2s ease;
    }

    .auto-refresh-panel select {
      transition: color 0.2s ease;
    }

    .auto-refresh-panel select:focus {
      outline: none;
    }

    /* æ»šåŠ¨æŒ‰é’®ç»„ä»¶æ ·å¼ */
    .scroll-buttons {
      position: fixed;
      right: 32px;
      bottom: 140px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 999;
      pointer-events: none;
    }

    .scroll-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: white;
      border: 2px solid #e2e8f0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.25s ease;
      color: #64748b;
      font-size: 16px;
      pointer-events: auto;
    }

    .scroll-btn:hover {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }

    .scroll-btn:active {
      transform: translateY(-1px) scale(1.02);
    }

    .scroll-btn.hidden {
      opacity: 0;
      pointer-events: none;
      transform: scale(0.8);
    }
  </style>
</head>

<body class="bg-[#F9FAFB] text-slate-900">
  <div id="app" class="flex h-screen overflow-hidden">
    <!-- ä¾§è¾¹æ  -->
    <aside class="w-64 bg-white border-r border-slate-200 flex-shrink-0 flex flex-col hidden md:flex">
      <div class="p-4 border-b border-slate-100 flex items-center gap-2">
        <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold">C</div>
        <span class="font-semibold text-lg">Claude Chat</span>
      </div>
      <div class="p-4 flex-1 overflow-y-auto custom-scrollbar space-y-2 sidebar-history-container">
        <button @click="resetChat"
          class="w-full py-2 px-4 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2">
          <i class="fa-solid fa-plus"></i> æ–°å¯¹è¯
        </button>
        <div class="mt-4">
          <h3 class="px-2 text-xs font-semibold text-slate-400 uppercase tracking-wider mb-3">å¯¹è¯è®°å½•</h3>
          <div class="space-y-1">
            <div v-for="h in chatHistory" :key="h.id" @click="loadHistoryConversation(h)"
              class="group relative px-3 py-2.5 text-sm text-slate-700 hover:bg-blue-50 rounded-md cursor-pointer truncate transition-colors font-medium flex items-center justify-between hover:gap-2"
              :class="{ 'bg-blue-100 text-blue-700': state.selectedHistoryId === h.id }">
              <span class="flex-1 truncate">{{ h.title }}</span>
              <button v-if="h.isRemote" @click.stop="deleteSession(h.sessionId)"
                class="opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0 text-slate-400 hover:text-red-600"
                title="åˆ é™¤ä¼šè¯">
                <i class="fa-solid fa-trash-can text-xs"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="hidden p-4 border-t border-slate-100">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-full bg-slate-200"></div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium truncate">User Admin</p>
            <p class="text-xs text-slate-500 truncate">Settings</p>
          </div>
        </div>
      </div>
    </aside>


    <!-- ä¸»ç•Œé¢ -->
    <main class="flex-1 h-full relative">

      <!-- å­ä»£ç†è§†å›¾è¦†ç›–å±‚ -->
      <div v-if="state.subagentView.active" class="absolute inset-0 bg-white z-50 flex flex-col">
        <!-- å­ä»£ç†é¡¶éƒ¨å¯¼èˆª -->
        <header class="h-16 bg-white border-b border-slate-200 px-6 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <button @click="closeSubagent"
              class="w-9 h-9 rounded-lg bg-slate-100 hover:bg-slate-200 flex items-center justify-center transition">
              <i class="fa-solid fa-arrow-left text-slate-700"></i>
            </button>
            <div>
              <h2 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <i class="fa-solid fa-robot text-purple-600"></i>
                å­ä»£ç†å¯¹è¯
              </h2>
              <p class="text-xs text-slate-500">{{ state.subagentView.description }}</p>
            </div>
          </div>
          <div class="flex items-center gap-4 text-sm">
            <button @click="toggleAllCollapseSubagent"
              class="text-slate-500 hover:text-purple-500 transition flex items-center gap-1.5" title="å…¨éƒ¨æŠ˜å /å±•å¼€">
              <i class="fa-solid" :class="state.subagentView.allCollapsed ? 'fa-angles-down' : 'fa-angles-up'"></i>
              {{ state.subagentView.allCollapsed ? 'å…¨éƒ¨å±•å¼€' : 'å…¨éƒ¨æŠ˜å ' }}
            </button>
            <div class="flex items-center gap-2 text-xs text-slate-500">
              <i class="fa-solid fa-layer-group"></i>
              <span>{{ state.subagentView.messages.length }} æ¡æ¶ˆæ¯</span>
            </div>
          </div>
        </header>

        <!-- å­ä»£ç†å¯¹è¯å†…å®¹ -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-4 bg-slate-50 subagent-messages-container">
          <template v-if="subagentGroupedMessages.length > 0">
            <div v-for="group in subagentGroupedMessages" :key="group.id" class="mb-4">
              <message-renderer :group="group" :is-subagent="true" :is-collapsed="isCollapsed"
                @toggle-collapse="toggleToolCollapse" @approve-permission="approvePermission"
                @deny-permission="denyPermission" @open-subagent="openSubagent">
              </message-renderer>
            </div>
          </template>
          <div v-else class="h-full flex items-center justify-center text-slate-400">
            <div class="text-center">
              <i class="fa-solid fa-inbox text-4xl mb-3"></i>
              <p>æš‚æ— å­ä»£ç†æ¶ˆæ¯</p>
            </div>
          </div>
        </div>

        <!-- æ»šåŠ¨æŒ‰é’®ç»„ä»¶ - ç§»åˆ°å¤–å±‚ -->
        <scroll-buttons v-if="state.subagentView.active" container-id="subagent-messages-container"></scroll-buttons>
      </div>

      <div class="w-full h-full flex flex-col  overflow-hidden" v-show="!state.subagentView.active">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header
          class="h-16 bg-white/80 backdrop-blur-md border-b border-slate-200 px-6 flex items-center justify-between sticky top-0 z-10">
          <div class="flex items-center gap-2">
            <!-- è‡ªå®šä¹‰ä¸‹æ‹‰æ¡† -->
            <div class="custom-dropdown" v-click-outside="closeDropdown">
              <div class="dropdown-header" :class="{ disabled: state.isStarting }">
                <!-- å·¦ä¾§ï¼šä¸‹æ‹‰è§¦å‘åŒºåŸŸ -->
                <div class="dropdown-trigger" :class="{ disabled: state.isStarting }"
                  @click="!state.isStarting && toggleDropdown()">
                  <span class="dropdown-trigger-text">
                    {{ state.selectedEvent || 'æµ‹è¯•åœºæ™¯' }}
                  </span>
                  <i class="fa-solid fa-chevron-down text-slate-400 dropdown-chevron"
                    :class="{ open: state.dropdownOpen }"></i>
                </div>

                <!-- å³ä¾§ï¼šè¿è¡ŒæŒ‰é’® -->
                <div class="dropdown-run-btn" :class="{ disabled: !state.selectedEvent || state.isStarting }"
                  @click.stop="sendTestRequest" :title="state.selectedEvent ? 'è¿è¡Œæµ‹è¯•' : 'è¯·å…ˆé€‰æ‹©æµ‹è¯•åœºæ™¯'">
                  <i class="fa-solid fa-play"></i>
                </div>
              </div>

              <!-- ä¸‹æ‹‰èœå• -->
              <div v-if="state.dropdownOpen" class="dropdown-menu">
                <div v-for="event in eventsList" :key="event.name" class="dropdown-item-wrapper"
                  :class="{ selected: state.selectedEvent === event.name }">
                  <div class="dropdown-item" @click="selectEvent(event.name)">
                    {{ event.name }}
                  </div>
                  <button @click.stop="deleteEvent(event.name)" class="dropdown-delete-btn" title="åˆ é™¤æ­¤äº‹ä»¶">
                    <i class="fa-solid fa-trash-can"></i>
                  </button>
                </div>
                <div v-if="eventsList.length === 0" class="dropdown-item text-slate-400 cursor-default">
                  æš‚æ— æµ‹è¯•åœºæ™¯
                </div>
              </div>
            </div>
          </div>
          <div class="flex items-center gap-4 text-sm">
            <!-- Session ID æ˜¾ç¤º -->
            <div v-if="state.session"
              class="flex items-center gap-2 px-3 py-1.5 bg-blue-50 border border-blue-200 rounded-lg">
              <i class="fa-solid fa-link text-blue-600"></i>
              <span class="text-xs font-medium text-blue-700">Session: {{ state.session.substring(0, 8) }}...</span>
              <button @click="copySessionId" class="text-blue-600 hover:text-blue-800 transition"
                title="å¤åˆ¶å®Œæ•´ Session ID">
                <i class="fa-solid fa-copy text-xs"></i>
              </button>
            </div>

            <div v-if="state.streamingId" class="flex items-center gap-2 text-green-600 font-medium">
              <span class="relative flex h-2 w-2">
                <span
                  class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
              </span>
              å·²è¿æ¥: {{ state.streamingId }}
            </div>

            <!-- è‡ªåŠ¨åˆ·æ–°æ§åˆ¶ -->
            <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg border transition-colors"
              :class="state.autoRefresh.enabled ? 'bg-green-50 border-green-300' : 'bg-slate-50 border-slate-200'">
              <button @click="toggleAutoRefresh" class="flex items-center gap-1.5 transition-colors"
                :class="state.autoRefresh.enabled ? 'text-green-600 hover:text-green-700' : 'text-slate-500 hover:text-slate-700'"
                :title="state.autoRefresh.enabled ? 'å…³é—­è‡ªåŠ¨åˆ·æ–°' : 'å¼€å¯è‡ªåŠ¨åˆ·æ–°'">
                <i class="fa-solid" :class="state.autoRefresh.enabled ? 'fa-rotate animate-spin' : 'fa-rotate'"></i>
                <span class="text-xs font-medium">{{ state.autoRefresh.enabled ? 'è‡ªåŠ¨åˆ·æ–°' : 'æ‰‹åŠ¨' }}</span>
              </button>
              <div class="h-4 w-px bg-slate-300"></div>

              <!-- è‡ªå®šä¹‰ä¸‹æ‹‰èœå• -->
              <div class="relative" v-click-outside="closeIntervalDropdown">
                <button @click="toggleIntervalDropdown"
                  class="flex items-center gap-1 text-xs font-medium cursor-pointer transition-colors px-2 py-1 rounded hover:bg-slate-100"
                  :class="state.autoRefresh.enabled ? 'text-green-600' : 'text-slate-600'">
                  <span>{{ getIntervalLabel(state.autoRefresh.interval) }}</span>
                  <i class="fa-solid fa-chevron-down text-[10px] transition-transform"
                    :class="{ 'rotate-180': state.autoRefresh.intervalDropdownOpen }"></i>
                </button>

                <!-- ä¸‹æ‹‰é€‰é¡¹ -->
                <div v-if="state.autoRefresh.intervalDropdownOpen"
                  class="absolute top-full right-0 mt-1 bg-white border border-slate-200 rounded-lg shadow-lg py-1 z-50 min-w-[100px]">
                  <div v-for="option in intervalOptions" :key="option.value" @click="selectInterval(option.value)"
                    class="px-3 py-2 text-xs cursor-pointer transition-colors flex items-center justify-between" :class="state.autoRefresh.interval === option.value 
                      ? 'bg-blue-50 text-blue-600 font-medium' 
                      : 'text-slate-700 hover:bg-slate-50'">
                    <span>{{ option.label }}</span>
                    <i v-if="state.autoRefresh.interval === option.value"
                      class="fa-solid fa-check text-blue-600 text-[10px]"></i>
                  </div>
                </div>
              </div>
            </div>

            <button @click="manualRefresh"
              class="text-slate-500 hover:text-blue-500 transition flex items-center gap-1.5" title="ç«‹å³åˆ·æ–°"
              :disabled="state.isRefreshing">
              <i class="fa-solid fa-arrows-rotate" :class="{ 'animate-spin': state.isRefreshing }"></i>
              åˆ·æ–°
            </button>

            <button @click="toggleAllCollapse"
              class="text-slate-500 hover:text-blue-500 transition flex items-center gap-1.5" title="å…¨éƒ¨æŠ˜å /å±•å¼€">
              <i class="fa-solid" :class="state.allCollapsed ? 'fa-angles-down' : 'fa-angles-up'"></i>
              {{ state.allCollapsed ? 'å…¨éƒ¨å±•å¼€' : 'å…¨éƒ¨æŠ˜å ' }}
            </button>
            <button @click="clearChat" class="text-slate-500 hover:text-red-500 transition flex items-center gap-1.5">
              <i class="fa-solid fa-trash"></i>
              æ¸…ç©ºå¯¹è¯
            </button>
          </div>
        </header>

        <!-- å¯¹è¯å†…å®¹åŒºåŸŸ -->
        <div id="chat-container" class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-4">
          <div v-if="chatItems.length === 0"
            class="h-full flex flex-col items-center justify-center text-center max-w-md mx-auto">
            <div
              class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-2xl flex items-center justify-center mb-6 shadow-lg">
              <i class="fa-solid fa-wand-magic-sparkles text-3xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">ä»Šå¤©èƒ½å¸®æ‚¨åšç‚¹ä»€ä¹ˆï¼Ÿ</h2>
            <p class="text-slate-500">æˆ‘å¯ä»¥å¸®æ‚¨ç¼–å†™ä»£ç ã€åˆ†ææ•°æ®æˆ–å›ç­”é—®é¢˜ã€‚è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ‚¨çš„éœ€æ±‚ã€‚</p>
          </div>

          <!-- åˆ†ç»„æ¸²æŸ“æ¶ˆæ¯ -->
          <template v-if="groupedMessages.length > 0">
            <div v-for="group in groupedMessages" :key="group.id" class="mb-4">
              <message-renderer :group="group" :is-subagent="false" :is-collapsed="isCollapsed"
                @toggle-collapse="toggleToolCollapse" @approve-permission="approvePermission"
                @deny-permission="denyPermission" @open-subagent="openSubagent">
                <template #actions v-if="showSaveButton && group === groupedMessages[groupedMessages.length - 1]">
                  <button @click="openSaveModal"
                    class="save-icon-btn text-slate-400 hover:text-blue-600 transition-colors" title="ä¿å­˜å¯¹è¯äº‹ä»¶">
                    <i class="fa-solid fa-floppy-disk text-xs"></i>
                  </button>
                </template>
              </message-renderer>
            </div>
            <div id="anchor" class="h-10"></div>
          </template>
        </div>

        <!-- æ»šåŠ¨æŒ‰é’®ç»„ä»¶ - ç§»åˆ°å¤–å±‚ -->
        <scroll-buttons v-if="!state.subagentView.active" container-id="chat-container"></scroll-buttons>

        <!-- è¾“å…¥åŒºåŸŸ - Gemini Style -->
        <footer v-show="state.showInputArea"
          class="p-6 bg-gradient-to-t from-white via-white to-transparent border-t border-slate-100">
          <div class="max-w-4xl mx-auto relative">
            <!-- å·²å­˜åœ¨ä¼šè¯çš„æç¤ºæ¶ˆæ¯ - æ˜¾ç¤ºåœ¨è¾“å…¥æ¡†ä¸Šæ–¹ -->
            <div v-if="state.inputDisabled" class="mb-3 px-4 py-2.5 rounded-lg flex items-center gap-3 text-sm border"
              :class="state.projectPathMissing 
                   ? 'bg-red-50 border-red-200 text-red-800' 
                   : 'bg-amber-50 border-amber-200 text-amber-800'">
              <i class="fa-solid text-base"
                :class="state.projectPathMissing ? 'fa-exclamation-triangle' : 'fa-info-circle'"></i>
              <div class="flex-1">
                <div v-if="state.projectPathMissing" class="font-semibold mb-0.5">é¡¹ç›®è·¯å¾„ä¸å­˜åœ¨</div>
                <div v-else class="font-semibold mb-0.5">ğŸ“ å·²å­˜åœ¨çš„ä¼šè¯</div>
                <div class="text-xs opacity-90">
                  <span v-if="state.projectPathMissing">é¡¹ç›®ç›®å½•å·²ä¸å­˜åœ¨ï¼Œæ— æ³•ç»§ç»­å¯¹è¯ã€‚è¯·æ£€æŸ¥è·¯å¾„æˆ–ç‚¹å‡»"æ–°å¯¹è¯"å¼€å§‹æ–°ä¼šè¯ã€‚</span>
                  <span v-else>è¿™æ˜¯ä¸€ä¸ªå·²å­˜åœ¨çš„ä¼šè¯ï¼Œå·¥ä½œç›®å½•å·²åŠ è½½ã€‚ç‚¹å‡»"æ–°å¯¹è¯"æŒ‰é’®å¼€å§‹æ–°çš„å¯¹è¯ã€‚</span>
                </div>
              </div>
            </div>

            <div class="input-container-gemini" :class="{ 'opacity-60 pointer-events-none': state.projectPathMissing }">
              <!-- Preview Area - Inside input container, above textarea -->
              <div class="preview-area-input" id="preview-area-input"></div>

              <!-- Textarea -->
              <textarea v-model="state.message" @keydown.enter="handleEnter" @paste="handlePaste" @input="autoResize"
                placeholder="ç»™ Claude å‘é€æ¶ˆæ¯..." ref="chatInput" :disabled="state.projectPathMissing"
                class="w-full border-none bg-transparent outline-none p-0 text-sm leading-relaxed max-h-[120px] resize-none text-slate-900 overflow-y-auto custom-scrollbar disabled:bg-gray-100 disabled:cursor-not-allowed disabled:opacity-60"
                :class="{ 'opacity-60 cursor-not-allowed bg-gray-100': state.projectPathMissing }" rows="1"></textarea>

              <!-- Bottom: Button Row -->
              <div class="button-row-input">
                <div class="left-buttons-input">
                  <label class="add-btn-input">
                    <input type="file" ref="fileInput" hidden accept="image/*" multiple @change="handleFileSelect">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                      stroke-linecap="round" stroke-linejoin="round">
                      <line x1="12" y1="5" x2="12" y2="19"></line>
                      <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                  </label>

                  <!-- ç›®å½•é€‰æ‹© -->
                  <div class="cwd-selector-wrapper">
                    <div class="cwd-input-container">
                      <i class="fa-solid fa-folder cwd-icon"></i>
                      <input v-model="state.currentCwd" @click.stop="toggleCwdDropdown" @input="handleCwdInput"
                        type="text" class="cwd-input" placeholder="å·¥ä½œç›®å½• (å¯é€‰)" title="é€‰æ‹©æˆ–è¾“å…¥å·¥ä½œç›®å½•">

                      <svg v-if="state.cwdList.length > 0" @click.stop="toggleCwdDropdown" class="cwd-dropdown-icon"
                        width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                        stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                      </svg>
                    </div>

                    <!-- CWD Dropdown -->
                    <div class="cwd-dropdown" :class="{ active: state.cwdDropdownOpen }" @click.stop>
                      <div v-if="state.cwdList.length === 0" class="cwd-dropdown-empty">
                        æš‚æ— å†å²ç›®å½•
                      </div>
                      <div v-else>
                        <div v-for="(cwd, index) in state.cwdList" :key="index" class="cwd-option"
                          :class="{ selected: state.currentCwd === cwd }" @click="selectCwd(cwd)">
                          <div class="cwd-option-content">
                            <i class="fa-solid fa-folder cwd-option-icon"></i>
                            <span>{{ cwd }}</span>
                          </div>
                          <button @click.stop="removeCwd(index)" class="cwd-remove-btn" title="åˆ é™¤">
                            <i class="fa-solid fa-xmark"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="right-buttons-input">
                  <!-- æ¨¡å‹é€‰æ‹©ä¸‹æ‹‰æ¡† -->
                  <div class="model-selector-input hidden" @click.stop="toggleModelDropdown">
                    <span>{{ state.selectedModel }}</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                      stroke-linecap="round" stroke-linejoin="round">
                      <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                  </div>
                  <button @click="state.streamingId ? abortSession() : startSession()"
                    :disabled="!state.streamingId && !canSend"
                    class="w-7 h-7 rounded-full flex items-center justify-center transition" :class="state.streamingId 
                      ? 'bg-slate-800 hover:bg-slate-900 text-white' 
                      : canSend 
                        ? 'bg-blue-600 hover:bg-blue-700 text-white' 
                        : 'bg-slate-200 text-slate-400'" :title="state.streamingId ? 'ä¸­æ–­å½“å‰ä¼šè¯' : 'å‘é€æ¶ˆæ¯'">
                    <i v-if="state.streamingId" class="fa-solid fa-stop text-sm"></i>
                    <i v-else-if="!state.isStarting" class="fa-solid fa-paper-plane text-sm"></i>
                    <span v-else
                      class="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
                  </button>
                </div>
              </div>
            </div>

            <!-- Model Dropdown -->
            <div class="model-dropdown-input" :class="{ active: state.modelDropdownOpen }" @click.stop>
              <div class="model-dropdown-header">Claude æ¨¡å‹</div>
              <div v-for="model in modelOptions" :key="model.name" class="model-option-input"
                :class="{ selected: state.selectedModel === model.name }" @click="selectModel(model.name)">
                <div class="model-option-content">
                  <div class="model-option-title">{{ model.name }}</div>
                  <div class="model-option-desc">{{ model.desc }}</div>
                </div>
                <div class="model-option-check">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                    stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </div>
              </div>
            </div>
          </div>
        </footer>
      </div>
    </main>

    <!-- Save Modal -->
    <div v-if="state.showSaveModal" class="modal-overlay" @click.self="closeSaveModal">
      <div class="modal-content">
        <h3 class="text-xl font-bold text-slate-800 mb-4">ä¿å­˜å¯¹è¯äº‹ä»¶</h3>
        <p class="text-sm text-slate-600 mb-4">è¯·è¾“å…¥äº‹ä»¶åç§°ï¼Œç”¨äºåç»­æµ‹è¯•åœºæ™¯é€‰æ‹©</p>
        <input v-model="state.saveEventName" @keydown.enter="saveEvents" type="text" placeholder="ä¾‹å¦‚: test-scenario-1"
          class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4">
        <div class="flex gap-3 justify-end">
          <button @click="closeSaveModal"
            class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-medium transition">
            å–æ¶ˆ
          </button>
          <button @click="saveEvents" :disabled="!state.saveEventName.trim()"
            class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
            <i v-if="!state.isSaving" class="fa-solid fa-check"></i>
            <span v-if="state.isSaving"
              class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
            {{ state.isSaving ? 'ä¿å­˜ä¸­...' : 'ç¡®è®¤ä¿å­˜' }}
          </button>
        </div>
      </div>
    </div>

    <!-- Image Viewer -->
    <div class="image-viewer" id="image-viewer">
      <div class="viewer-close" id="viewer-close">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </div>
      <div class="viewer-image-wrapper" id="viewer-image-wrapper">
        <img class="viewer-image" id="viewer-image" src="" alt="">
      </div>
      <div class="viewer-controls">
        <button class="viewer-btn" id="zoom-out">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            <line x1="8" y1="11" x2="14" y2="11"></line>
          </svg>
        </button>
        <div class="viewer-zoom-level" id="zoom-level">100%</div>
        <button class="viewer-btn" id="zoom-in">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            <line x1="11" y1="8" x2="11" y2="14"></line>
            <line x1="8" y1="11" x2="14" y2="11"></line>
          </svg>
        </button>
        <button class="viewer-btn" id="zoom-reset">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M1 4v6h6M23 20v-6h-6"></path>
            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    const { createApp, ref, reactive, onMounted, onBeforeUnmount, nextTick, watch, computed } = Vue;

    // æ¶ˆæ¯æ¸²æŸ“ç»„ä»¶
    const MessageRenderer = {
      template: '#message-renderer-template',
      props: {
        group: {
          type: Object,
          required: true
        },
        isSubagent: {
          type: Boolean,
          default: false
        },
        isCollapsed: {
          type: Function,
          required: true
        }
      },
      emits: ['toggle-collapse', 'approve-permission', 'deny-permission', 'open-subagent']
    };

    // æ»šåŠ¨æŒ‰é’®ç»„ä»¶
    const ScrollButtons = {
      template: `
        <div class="scroll-buttons">
          <button 
            v-show="showScrollTop" 
            @click="scrollToTop" 
            class="scroll-btn"
            title="å›åˆ°é¡¶éƒ¨">
            <i class="fa-solid fa-chevron-up"></i>
          </button>
          <button 
            v-show="showScrollBottom" 
            @click="scrollToBottom" 
            class="scroll-btn"
            title="å›åˆ°åº•éƒ¨">
            <i class="fa-solid fa-chevron-down"></i>
          </button>
        </div>
      `,
      props: {
        containerId: {
          type: String,
          required: true
        }
      },
      data() {
        return {
          showScrollTop: false,
          showScrollBottom: false,
          scrollThreshold: 100 // è·ç¦»é¡¶éƒ¨/åº•éƒ¨å¤šå°‘åƒç´ æ—¶æ˜¾ç¤ºæŒ‰é’®
        };
      },
      mounted() {
        this.container = document.querySelector(`.${this.containerId}`) || document.getElementById(this.containerId);
        if (this.container) {
          this.container.addEventListener('scroll', this.handleScroll);
          this.handleScroll(); // åˆå§‹æ£€æŸ¥
        }
      },
      beforeUnmount() {
        if (this.container) {
          this.container.removeEventListener('scroll', this.handleScroll);
        }
      },
      methods: {
        handleScroll() {
          if (!this.container) return;

          const { scrollTop, scrollHeight, clientHeight } = this.container;
          const distanceFromTop = scrollTop;
          const distanceFromBottom = scrollHeight - scrollTop - clientHeight;

          // æ˜¾ç¤ºå›åˆ°é¡¶éƒ¨æŒ‰é’®ï¼šä¸åœ¨é¡¶éƒ¨æ—¶
          this.showScrollTop = distanceFromTop > this.scrollThreshold;

          // æ˜¾ç¤ºå›åˆ°åº•éƒ¨æŒ‰é’®ï¼šä¸åœ¨åº•éƒ¨æ—¶
          this.showScrollBottom = distanceFromBottom > this.scrollThreshold;
        },
        scrollToTop() {
          if (this.container) {
            this.container.scrollTo({
              top: 0,
              behavior: 'smooth'
            });
          }
        },
        scrollToBottom() {
          if (this.container) {
            this.container.scrollTo({
              top: this.container.scrollHeight,
              behavior: 'smooth'
            });
          }
        }
      }
    };

    createApp({
      components: {
        MessageRenderer,
        ScrollButtons
      },
      setup() {
        const state = reactive({
          message: '',
          isStarting: false,
          isRefreshing: false,
          streamingId: '',
          session: '', // å½“å‰ä¼šè¯ ID
          status: '',
          selectedEvent: '',
          dropdownOpen: false,
          selectedModel: 'Claude 3.5 Sonnet',
          modelDropdownOpen: false,
          currentCwd: '', // å½“å‰å·¥ä½œç›®å½•
          cwdList: [], // å·¥ä½œç›®å½•å†å²åˆ—è¡¨
          cwdDropdownOpen: false, // å·¥ä½œç›®å½•ä¸‹æ‹‰èœå•æ˜¯å¦æ‰“å¼€
          uploadedImages: [],
          showSaveModal: false,
          saveEventName: '',
          isSaving: false,
          conversationEnded: false,
          allEvents: [], // å­˜å‚¨æ‰€æœ‰æ¥æ”¶åˆ°çš„äº‹ä»¶
          selectedHistoryId: 1, // å½“å‰é€‰ä¸­çš„å†å²è®°å½• ID
          allCollapsed: false, // ä¸»å¯¹è¯å…¨éƒ¨æŠ˜å çŠ¶æ€
          showInputArea: true, // æ˜¯å¦æ˜¾ç¤ºè¾“å…¥åŒºåŸŸ
          inputDisabled: false, // è¾“å…¥æ¡†æ˜¯å¦ç¦ç”¨
          projectPathMissing: false, // é¡¹ç›®è·¯å¾„æ˜¯å¦ç¼ºå¤±
          subagentView: {
            active: false,
            messages: [],
            description: '',
            scrollPosition: 0,
            allCollapsed: false // å­ä»£ç†å…¨éƒ¨æŠ˜å çŠ¶æ€
          },
          autoRefresh: {
            enabled: false, // æ˜¯å¦å¯ç”¨è‡ªåŠ¨åˆ·æ–°
            interval: 5000, // åˆ·æ–°é—´éš”ï¼ˆæ¯«ç§’ï¼‰
            timerId: null, // å®šæ—¶å™¨ ID
            lastRefreshTime: null, // ä¸Šæ¬¡åˆ·æ–°æ—¶é—´
            intervalDropdownOpen: false // é—´éš”ä¸‹æ‹‰èœå•æ˜¯å¦æ‰“å¼€
          }
        });

        // ä½¿ç”¨ Map å­˜å‚¨æŠ˜å çŠ¶æ€ï¼Œkey ä¸ºæ¶ˆæ¯ id
        const collapseStateMap = reactive(new Map());
        const subagentCollapseStateMap = reactive(new Map());

        const chatItems = ref([]);
        const eventsList = ref([]);

        // åˆ·æ–°é—´éš”é€‰é¡¹
        const intervalOptions = [
          { value: 500, label: '0.5ç§’' },
          { value: 1000, label: '1ç§’' },
          { value: 2000, label: '2ç§’' },
          { value: 3000, label: '3ç§’' },
          { value: 5000, label: '5ç§’' },
          { value: 10000, label: '10ç§’' },
          { value: 30000, label: '30ç§’' },
          { value: 60000, label: '1åˆ†é’Ÿ' }
        ];

        // é»˜è®¤å¯¹è¯æ•°æ®
        const defaultConversation = [
          {
            id: 'msg-001',
            role: 'user',
            kind: 'text',
            rawText: 'å¸®æˆ‘åˆ—å‡ºå½“å‰ç›®å½•çš„æ–‡ä»¶',
            time: '14:30'
          },
          {
            id: 'msg-002',
            role: 'assistant',
            kind: 'text',
            rawText: 'å¥½çš„ï¼Œæˆ‘æ¥å¸®ä½ æ‰§è¡Œ ls å‘½ä»¤æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨ã€‚',
            time: '14:30'
          },
          {
            id: 'msg-003',
            role: 'assistant',
            kind: 'tool',
            name: 'Bash',
            input: {
              command: 'ls -la'
            },
            result: 'total 48\ndrwxr-xr-x  5 user  staff   160 Jan 26 14:30 .\ndrwxr-xr-x  8 user  staff   256 Jan 25 10:00 ..\n-rw-r--r--  1 user  staff  1024 Jan 26 14:25 file1.txt\n-rw-r--r--  1 user  staff  2048 Jan 26 14:28 file2.js\n-rw-r--r--  1 user  staff   512 Jan 26 14:20 README.md',
            tool_use_id: 'tool-001',
            isError: false,
            time: '14:30'
          },
          {
            id: 'msg-004',
            role: 'assistant',
            kind: 'text',
            rawText: 'å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼å½“å‰ç›®å½•æœ‰ä»¥ä¸‹æ–‡ä»¶ï¼š\n\n- **file1.txt** (1KB)\n- **file2.js** (2KB)\n- **README.md** (512B)',
            time: '14:30'
          },
          {
            id: 'msg-005',
            role: 'user',
            kind: 'text',
            rawText: 'å¸®æˆ‘åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ test.jsï¼ŒåŒ…å«ä¸€ä¸ªç®€å•çš„å‡½æ•°',
            time: '14:31'
          },
          {
            id: 'msg-006',
            role: 'assistant',
            kind: 'text',
            rawText: 'å¥½çš„ï¼Œæˆ‘æ¥åˆ›å»ºè¿™ä¸ªæ–‡ä»¶ï¼ŒåŒ…å«ä¸€ä¸ªæµ‹è¯•å‡½æ•°ã€‚',
            time: '14:31'
          },
          {
            id: 'msg-007',
            role: 'assistant',
            kind: 'tool',
            name: 'Write',
            input: {
              path: 'test.js',
              content: 'console.log("Hello World");\n\nfunction test() {\n  return true;\n}\n\nmodule.exports = { test };'
            },
            result: 'æ–‡ä»¶åˆ›å»ºæˆåŠŸ',
            tool_use_id: 'tool-002',
            isError: false,
            diffLines: [
              { type: 'add', content: '+ console.log("Hello World");' },
              { type: 'add', content: '+ ' },
              { type: 'add', content: '+ function test() {' },
              { type: 'add', content: '+   return true;' },
              { type: 'add', content: '+ }' },
              { type: 'add', content: '+ ' },
              { type: 'add', content: '+ module.exports = { test };' }
            ],
            time: '14:31'
          },
          {
            id: 'msg-008',
            role: 'assistant',
            kind: 'text',
            rawText: 'æ–‡ä»¶ `test.js` å·²åˆ›å»ºæˆåŠŸï¼åŒ…å«äº†ä¸€ä¸ªç®€å•çš„æµ‹è¯•å‡½æ•°ã€‚',
            time: '14:31'
          },
          {
            id: 'msg-009',
            role: 'user',
            kind: 'text',
            rawText: 'ç°åœ¨å¸®æˆ‘è§„åˆ’ä¸€ä¸‹æ¥ä¸‹æ¥çš„å¼€å‘ä»»åŠ¡',
            time: '14:32'
          },
          {
            id: 'msg-010',
            role: 'assistant',
            kind: 'text',
            rawText: 'å¥½çš„ï¼Œè®©æˆ‘ä¸ºä½ è§„åˆ’ä¸€ä¸‹å¼€å‘ä»»åŠ¡æ¸…å•ã€‚',
            time: '14:32'
          },
          {
            id: 'msg-011',
            role: 'assistant',
            kind: 'todo_list',
            name: 'TodoWrite',
            input: {
              todos: [
                {
                  id: 'todo-1',
                  content: 'åˆ†æé¡¹ç›®ç»“æ„å’Œä¾èµ–',
                  status: 'completed',
                  activeForm: null
                },
                {
                  id: 'todo-2',
                  content: 'åˆ›å»ºé…ç½®æ–‡ä»¶ config.json',
                  status: 'in_progress',
                  activeForm: 'config.json'
                },
                {
                  id: 'todo-3',
                  content: 'ç¼–å†™å•å…ƒæµ‹è¯•',
                  status: 'pending',
                  activeForm: null
                },
                {
                  id: 'todo-4',
                  content: 'æ·»åŠ é”™è¯¯å¤„ç†æœºåˆ¶',
                  status: 'pending',
                  activeForm: null
                },
                {
                  id: 'todo-5',
                  content: 'ä¼˜åŒ–æ€§èƒ½å’Œä»£ç è´¨é‡',
                  status: 'pending',
                  activeForm: null
                }
              ]
            },
            todos: [
              {
                id: 'todo-1',
                content: 'åˆ†æé¡¹ç›®ç»“æ„å’Œä¾èµ–',
                status: 'completed',
                activeForm: null
              },
              {
                id: 'todo-2',
                content: 'åˆ›å»ºé…ç½®æ–‡ä»¶ config.json',
                status: 'in_progress',
                activeForm: 'config.json'
              },
              {
                id: 'todo-3',
                content: 'ç¼–å†™å•å…ƒæµ‹è¯•',
                status: 'pending',
                activeForm: null
              },
              {
                id: 'todo-4',
                content: 'æ·»åŠ é”™è¯¯å¤„ç†æœºåˆ¶',
                status: 'pending',
                activeForm: null
              },
              {
                id: 'todo-5',
                content: 'ä¼˜åŒ–æ€§èƒ½å’Œä»£ç è´¨é‡',
                status: 'pending',
                activeForm: null
              }
            ],
            tool_use_id: 'tool-003',
            time: '14:32'
          },
          {
            id: 'msg-012',
            role: 'assistant',
            kind: 'text',
            rawText: 'ä»»åŠ¡æ¸…å•å·²åˆ›å»ºï¼ç›®å‰æ­£åœ¨è¿›è¡Œé…ç½®æ–‡ä»¶çš„åˆ›å»ºå·¥ä½œã€‚',
            time: '14:32'
          }
        ];

        // å†å²è®°å½•åˆ—è¡¨ï¼ŒåŒ…å«å¯¹è¯æ•°æ®
        const chatHistory = ref([
          {
            id: 1,
            title: 'Session: Claude Code Demo',
            messages: defaultConversation
          }
        ]);

        const modelOptions = [
          { name: 'Claude 3.5 Sonnet', desc: 'å¿«é€Ÿå›ç­”ï¼Œé€‚åˆæ—¥å¸¸å¯¹è¯' },
          { name: 'Claude 3 Opus', desc: 'æ·±åº¦æ€è€ƒï¼Œè§£å†³å¤æ‚é—®é¢˜' },
          { name: 'Claude 3 Haiku', desc: 'è½»é‡å¿«é€Ÿï¼Œç®€å•ä»»åŠ¡' }
        ];

        const canSend = computed(() => {
          return (state.message.trim() || state.uploadedImages.length > 0) && !state.isStarting;
        });

        const showSaveButton = computed(() => {
          return state.conversationEnded && chatItems.value.length > 0 && state.allEvents.length > 0;
        });

        // è®¡ç®—å±æ€§ï¼šå°† chatItems æŒ‰è§’è‰²åˆ†ç»„
        const groupedMessages = computed(() => {
          const groups = [];
          let currentGroup = null;

          chatItems.value.forEach(item => {
            if (item.role === 'user') {
              // ç”¨æˆ·æ¶ˆæ¯å•ç‹¬æˆç»„ï¼Œä½¿ç”¨ marked è½¬æ¢ rawText
              groups.push({
                id: item.id,
                role: 'user',
                html: item.html || item.rawText,
                time: item.time
              });
              currentGroup = null;
            } else if (item.role === 'assistant') {
              // AI æ¶ˆæ¯åˆå¹¶åˆ°å½“å‰ç»„
              if (!currentGroup || currentGroup.role !== 'assistant') {
                currentGroup = {
                  id: `group-${item.id}`,
                  role: 'assistant',
                  items: [],
                  time: item.time
                };
                groups.push(currentGroup);
              }

              // ä¸ºæ–‡æœ¬ç±»å‹çš„æ¶ˆæ¯æ·»åŠ  html å±æ€§
              const processedItem = { ...item };
              if (item.kind === 'text' && !item.html && item.rawText) {
                processedItem.html = marked.parse(item.rawText);
              }

              currentGroup.items.push(processedItem);
              currentGroup.time = item.time; // æ›´æ–°æ—¶é—´ä¸ºæœ€æ–°
            }
          });

          return groups;
        });

        // è®¡ç®—å±æ€§ï¼šå­ä»£ç†æ¶ˆæ¯åˆ†ç»„
        const subagentGroupedMessages = computed(() => {
          const groups = [];
          let currentGroup = null;

          state.subagentView.messages.forEach(item => {
            if (item.role === 'user') {
              groups.push({
                id: item.id,
                role: 'user',
                html: item.html || item.rawText,
                time: item.time
              });
              currentGroup = null;
            } else if (item.role === 'assistant') {
              if (!currentGroup || currentGroup.role !== 'assistant') {
                currentGroup = {
                  id: `subagent-group-${item.id}`,
                  role: 'assistant',
                  items: [],
                  time: item.time
                };
                groups.push(currentGroup);
              }

              const processedItem = { ...item };
              if (item.kind === 'text' && !item.html && item.rawText) {
                processedItem.html = marked.parse(item.rawText);
              }

              currentGroup.items.push(processedItem);
              currentGroup.time = item.time;
            }
          });

          return groups;
        });

        let eventSource = null;

        const toggleToolCollapse = (item) => {
          // æ ¹æ®å½“å‰è§†å›¾é€‰æ‹©å¯¹åº”çš„ Map
          const targetMap = state.subagentView.active ? subagentCollapseStateMap : collapseStateMap;

          // åˆ‡æ¢æŠ˜å çŠ¶æ€
          const currentState = targetMap.get(item.id) || false;
          targetMap.set(item.id, !currentState);
        };

        // è·å–æŠ˜å çŠ¶æ€çš„è¾…åŠ©å‡½æ•°
        const isCollapsed = (itemId, isSubagent = false) => {
          const targetMap = isSubagent ? subagentCollapseStateMap : collapseStateMap;
          return targetMap.get(itemId) || false;
        };

        const formatTime = (date) => {
          return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        };

        const scrollToBottom = (smooth = true) => {
          nextTick(() => {
            const container = document.getElementById('chat-container');
            if (container) {
              container.scrollTo({
                top: container.scrollHeight,
                behavior: smooth ? 'smooth' : 'auto'
              });
            }
          });
        };

        // æ™ºèƒ½æ»šåŠ¨ï¼šåªæœ‰åœ¨æ¥è¿‘åº•éƒ¨æ—¶æ‰è‡ªåŠ¨æ»šåŠ¨
        const smartScrollToBottom = (smooth = true, threshold = 100) => {
          nextTick(() => {
            const container = document.getElementById('chat-container');
            if (container) {
              const scrollTop = container.scrollTop;
              const scrollHeight = container.scrollHeight;
              const clientHeight = container.clientHeight;
              const distanceFromBottom = scrollHeight - scrollTop - clientHeight;

              // åªæœ‰å½“è·ç¦»åº•éƒ¨å°äºé˜ˆå€¼æ—¶æ‰æ»šåŠ¨
              if (distanceFromBottom <= threshold) {
                container.scrollTo({
                  top: scrollHeight,
                  behavior: smooth ? 'smooth' : 'auto'
                });
              }
            }
          });
        };

        const scrollSidebarToBottom = (smooth = true) => {
          nextTick(() => {
            const sidebar = document.querySelector('.sidebar-history-container');
            if (sidebar) {
              sidebar.scrollTo({
                top: sidebar.scrollHeight,
                behavior: smooth ? 'smooth' : 'auto'
              });
            }
          });
        };

        const scrollSubagentToBottom = (smooth = true) => {
          nextTick(() => {
            const subagentContainer = document.querySelector('.subagent-messages-container');
            if (subagentContainer) {
              subagentContainer.scrollTo({
                top: subagentContainer.scrollHeight,
                behavior: smooth ? 'smooth' : 'auto'
              });
            }
          });
        };

        const addChatItem = (item) => {
          const id = item.id || Math.random().toString(36).substr(2, 9);
          chatItems.value.push({ ...item, id, time: formatTime(new Date()) });
          smartScrollToBottom(true, 150); // ä½¿ç”¨æ™ºèƒ½æ»šåŠ¨ï¼Œåªæœ‰åœ¨åº•éƒ¨é™„è¿‘æ‰æ»šåŠ¨
        };

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        const showErrorMessage = (errorMessage, error = null) => {
          const fullMessage = error ? `${errorMessage}: ${error.message || error}` : errorMessage;
          console.error(fullMessage, error);
          chatItems.value = [{
            type: 'error',
            content: fullMessage,
            timestamp: new Date().toISOString()
          }];
        };

        // æµå¤„ç†é€»è¾‘
        const startStream = (id, url) => {
          if (eventSource) eventSource.close();
          state.streamingId = id;
          state.status = 'SSE è¿æ¥ä¸­...';
          state.conversationEnded = false;
          state.allEvents = []; // é‡ç½®äº‹ä»¶åˆ—è¡¨
          eventSource = new EventSource(url);

          eventSource.onopen = () => {
            console.log('SSE Connected:', url);
            state.status = 'å·²è¿æ¥ï¼Œç­‰å¾…æ•°æ®...';
          };

          eventSource.onmessage = (e) => {
            try {
              const data = JSON.parse(e.data);
              console.log("Stream Event:", data);

              // ä¿å­˜æ‰€æœ‰äº‹ä»¶
              state.allEvents.push(data);

              handleStreamEvent(data);
            } catch (err) {
              console.error("Parse Error:", err, "Raw data:", e.data);
            }
          };

          eventSource.onerror = (e) => {
            console.error("SSE Error:", e);
            state.status = 'è¿æ¥å·²ä¸­æ–­';
            stopStream();
          };
        };

        const stopStream = () => {
          if (eventSource) {
            eventSource.close();
            eventSource = null;
          }
          state.streamingId = '';
          state.isStarting = false;
        };

        // æ ¸å¿ƒè§£æé€»è¾‘ï¼šæ”¯æŒåµŒå¥—æ ¼å¼
        const handleStreamEvent = (data) => {
          console.log('handleStreamEvent:', data);

          // 0. æ£€æŸ¥å¹¶è®¾ç½® sessionIdï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if (data.session_id && !state.session) {
            state.session = data.session_id;
            // åˆ·æ–°ä¸€ä¸‹åˆ—è¡¨
            manualRefresh()
            console.log('Session ID set from stream:', data.session_id);
          }

          // 1. å¤„ç† message ç±»å‹ï¼ˆä¸»è¦çš„æ¶ˆæ¯æ ¼å¼ï¼‰
          if (data.type === 'message' && Array.isArray(data.content)) {
            data.content.forEach(contentBlock => {
              if (contentBlock.type === 'text' && contentBlock.text) {
                updateTextContent(contentBlock.text);
              } else if (contentBlock.type === 'thinking' && contentBlock.thinking) {
                updateTextContent(contentBlock.thinking);
              } else if (contentBlock.type === 'tool_use') {
                handleToolUse(contentBlock);
              }
            });
          }
          // 2. å¤„ç†åŸºç¡€ content ç±»å‹
          else if (data.type === 'content') {
            updateTextContent(data.content);
          }
          // 3. å¤„ç† content_block_delta ç±»å‹ï¼ˆæµå¼æ–‡æœ¬å¢é‡ï¼‰
          else if (data.type === 'content_block_delta' && data.delta?.text) {
            updateTextContent(data.delta.text);
          }
          // 4. å¤„ç† assistant ç±»å‹çš„åµŒå¥—æ¶ˆæ¯
          else if (data.type === 'assistant' && data.message?.content) {
            data.message.content.forEach(contentBlock => {
              if (contentBlock.type === 'text') {
                updateTextContent(contentBlock.text);
              } else if (contentBlock.type === 'tool_use') {
                handleToolUse(contentBlock);
              }
            });
          }
          // 5. å¤„ç†ç‹¬ç«‹çš„ tool_use
          else if (data.type === 'tool_use') {
            handleToolUse(data);
          }
          // 6. å¤„ç† user ç±»å‹ï¼ˆåŒ…å« tool_resultï¼‰
          else if (data.type === 'user' && Array.isArray(data.message?.content)) {
            data.message.content.forEach(block => {
              if (block.type === 'tool_result' && block.tool_use_id) {
                const resText = typeof block.content === 'string'
                  ? block.content
                  : Array.isArray(block.content)
                    ? block.content.map(p => p.text || '').join('\n')
                    : JSON.stringify(block.content);

                const targetIndex = chatItems.value.findIndex(i => i.tool_use_id === block.tool_use_id);
                if (targetIndex >= 0) {
                  // åˆ›å»ºæ–°å¯¹è±¡ä»¥è§¦å‘å“åº”å¼æ›´æ–°
                  chatItems.value[targetIndex] = {
                    ...chatItems.value[targetIndex],
                    result: resText,
                    isError: block.is_error
                  };
                }
              }
            });
          }
          // 7. å¤„ç†ç‹¬ç«‹çš„ tool_result
          else if (data.type === 'tool_result') {
            const targetIndex = chatItems.value.findIndex(i => i.tool_use_id === data.tool_use_id);
            if (targetIndex >= 0) {
              // åˆ›å»ºæ–°å¯¹è±¡ä»¥è§¦å‘å“åº”å¼æ›´æ–°
              chatItems.value[targetIndex] = {
                ...chatItems.value[targetIndex],
                result: data.result,
                isError: data.is_error
              };
            }
          }
          // 8. å¤„ç†æƒé™è¯·æ±‚
          else if (data.type === 'permission_request') {
            const req = data.permission || data;
            addChatItem({
              role: 'assistant',
              kind: 'permission_request',
              toolName: req.toolName,
              toolInput: req.toolInput,
              payload: req.payload,
              requestId: req.id
            });
          }
          // 9. å¤„ç†æƒé™å†³ç­–
          else if (data.type === 'permission_decision') {
            // æƒé™å·²å¤„ç†ï¼Œå¯ä»¥ç§»é™¤å¯¹åº”çš„è¯·æ±‚å¡ç‰‡
            if (data.permission?.id) {
              chatItems.value = chatItems.value.filter(i => i.requestId !== data.permission.id);
            }
          }
          // 10. å¤„ç†é”™è¯¯
          else if (data.type === 'error') {
            state.status = `é”™è¯¯ï¼š${data.stderr || data.error || 'unknown'}`;
            addChatItem({
              role: 'assistant',
              kind: 'text',
              rawText: `âŒ é”™è¯¯: ${data.stderr || data.error || 'unknown'}`,
              html: marked.parse(`âŒ é”™è¯¯: ${data.stderr || data.error || 'unknown'}`)
            });
          }
          // 11. å¤„ç†æµç»“æŸ
          else if (data.type === 'process_end') {
            state.status = `ç»“æŸ code=${data.code}`;
            state.conversationEnded = true;
            stopStream();
          }
          // 12. å¤„ç†ä¸­æ–­äº‹ä»¶
          else if (data.type === 'aborted') {
            state.status = 'ä¼šè¯å·²ä¸­æ–­';
            state.conversationEnded = true;
            addChatItem({
              role: 'assistant',
              kind: 'text',
              rawText: `âš ï¸ ${data.message || 'ä¼šè¯å·²è¢«ç”¨æˆ·ä¸­æ–­'}`,
              html: marked.parse(`âš ï¸ ${data.message || 'ä¼šè¯å·²è¢«ç”¨æˆ·ä¸­æ–­'}`)
            });
            stopStream();
          }
        };

        const updateTextContent = (text) => {
          if (!text) return;

          const last = chatItems.value[chatItems.value.length - 1];
          if (last && last.role === 'assistant' && last.kind === 'text') {
            // è¿½åŠ åˆ°ç°æœ‰æ¶ˆæ¯ - åˆ›å»ºæ–°å¯¹è±¡ä»¥è§¦å‘å“åº”å¼æ›´æ–°
            const newRawText = (last.rawText || '') + text;
            chatItems.value[chatItems.value.length - 1] = {
              ...last,
              rawText: newRawText,
              html: marked.parse(newRawText)
            };
          } else {
            // åˆ›å»ºæ–°æ¶ˆæ¯
            addChatItem({
              role: 'assistant',
              kind: 'text',
              rawText: text,
              html: marked.parse(text)
            });
          }
          // æµå¼è¾“å‡ºæ—¶ä½¿ç”¨æ™ºèƒ½æ»šåŠ¨
          smartScrollToBottom(true);
        };

        const handleToolUse = (toolData) => {
          console.log('handleToolUse:', toolData);

          // å¤„ç† Task å·¥å…·ï¼ˆå­ä»£ç†ï¼‰
          if (toolData.name === 'Task') {
            addChatItem({
              role: 'assistant',
              kind: 'subagent',
              name: toolData.name,
              input: toolData.input,
              result: '',
              tool_use_id: toolData.id,
              isError: false,
              subagentMessages: [], // å­ä»£ç†æ¶ˆæ¯åˆ—è¡¨
              agentId: null // ç¨åå¡«å……
            });
            return;
          }

          // å¤„ç† TodoWrite å·¥å…·
          if (toolData.name === 'TodoWrite' && toolData.input?.todos) {
            addChatItem({
              role: 'assistant',
              kind: 'todo_list',
              name: toolData.name,
              input: toolData.input,
              todos: toolData.input.todos,
              tool_use_id: toolData.id
            });
            return;
          }

          let item = {
            role: 'assistant',
            kind: 'tool',
            name: toolData.name,
            input: toolData.input,
            result: '',
            tool_use_id: toolData.id,
            isError: false
          };

          // å¦‚æœæ˜¯ Write ä¸”æœ‰å†…å®¹ï¼Œç”Ÿæˆé¢„è§ˆ
          if (toolData.name === 'Write' && toolData.input?.content) {
            item.diffLines = generatePreviewDiff(toolData.input.content);
          }

          addChatItem(item);
        };

        const approvePermission = async (item) => {
          try {
            const res = await fetch(`/api/chat/permissions/${item.requestId}/decision`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ action: 'approve' })
            });
            if (res.ok) {
              chatItems.value = chatItems.value.filter(i => i.id !== item.id);
              state.status = 'æƒé™å·²æ‰¹å‡†';
            } else {
              const data = await res.json();
              state.status = `å®¡æ‰¹å¤±è´¥: ${data.error || res.statusText}`;
            }
          } catch (e) {
            state.status = "å®¡æ‰¹å¤±è´¥: " + e.message;
          }
        };

        const denyPermission = async (item) => {
          try {
            const res = await fetch(`/api/chat/permissions/${item.requestId}/decision`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ action: 'deny' })
            });
            if (res.ok) {
              chatItems.value = chatItems.value.filter(i => i.id !== item.id);
              state.status = 'æƒé™å·²æ‹’ç»';
            } else {
              const data = await res.json();
              state.status = `æ‹’ç»å¤±è´¥: ${data.error || res.statusText}`;
            }
          } catch (e) {
            state.status = "æ‹’ç»å¤±è´¥: " + e.message;
          }
        };

        const abortSession = async () => {
          if (!state.streamingId) {
            console.log('æ²¡æœ‰æ´»åŠ¨çš„ä¼šè¯å¯ä»¥ä¸­æ–­');
            return;
          }

          try {
            state.status = 'æ­£åœ¨ä¸­æ–­...';
            const res = await fetch('/api/chat/abort', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                streamingId: state.streamingId
              })
            });

            const data = await res.json();
            if (res.ok) {
              state.status = 'ä¼šè¯å·²ä¸­æ–­';
              // ä¸åœ¨è¿™é‡Œæ·»åŠ æ¶ˆæ¯ï¼Œç­‰å¾…æœåŠ¡å™¨å‘é€ aborted äº‹ä»¶
              // æœåŠ¡å™¨ä¼šé€šè¿‡ SSE å‘é€ aborted äº‹ä»¶ï¼ŒhandleStreamEvent ä¼šå¤„ç†

              // 2ç§’åæ¸…é™¤çŠ¶æ€
              setTimeout(() => {
                if (state.status === 'ä¼šè¯å·²ä¸­æ–­') {
                  state.status = '';
                }
              }, 2000);
            } else {
              state.status = 'ä¸­æ–­å¤±è´¥: ' + data.error;
              console.error('ä¸­æ–­å¤±è´¥:', data.error);
            }
          } catch (e) {
            state.status = 'ä¸­æ–­è¯·æ±‚å¤±è´¥: ' + e.message;
            console.error('ä¸­æ–­è¯·æ±‚å¤±è´¥:', e);
          }
        };

        const startSession = async () => {
          const msg = state.message.trim();
          if (!canSend.value) return;

          addChatItem({ role: 'user', kind: 'text', html: marked.parse(msg || '(é™„å¸¦å›¾ç‰‡)') });
          state.message = '';
          state.uploadedImages = [];
          renderImagePreviews();
          state.isStarting = true;
          state.status = 'å‘é€ä¸­...';

          // å¦‚æœæœ‰ cwd ä¸”ä¸æ˜¯æ¢å¤ä¼šè¯ï¼Œä¿å­˜åˆ°åˆ—è¡¨
          if (state.currentCwd && !state.session) {
            addCwdToList(state.currentCwd);
          }

          try {
            const requestBody = {
              message: msg,
              mock: false,
              ...(state.session && { session: state.session }),
              ...(state.currentCwd && !state.session && { cwd: state.currentCwd })
            };

            const res = await fetch('/api/chat/start', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(requestBody)
            });
            const data = await res.json();
            if (res.ok) {
              state.status = 'æµè¿æ¥ä¸­...';
              // ä¿å­˜ session IDï¼ˆå¦‚æœæœåŠ¡å™¨è¿”å›ï¼‰
              if (data.session) {
                state.session = data.session;
              }
              startStream(data.streamingId, data.streamUrl);
            } else {
              state.status = 'Error: ' + data.error;
              state.isStarting = false;
            }
          } catch (e) {
            state.status = 'è¯·æ±‚å¤±è´¥';
            state.isStarting = false;
          }
        };

        const sendTestRequest = async () => {
          if (state.isStarting || !state.selectedEvent) return;

          const testMessage = `æµ‹è¯•åœºæ™¯: ${state.selectedEvent}`;
          addChatItem({ role: 'user', kind: 'text', html: marked.parse(testMessage) });
          state.isStarting = true;
          state.status = 'å‘é€æµ‹è¯•è¯·æ±‚...';

          try {
            const res = await fetch('/api/chat/start', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                message: testMessage,
                mock: true,
                eventName: state.selectedEvent
              })
            });
            const data = await res.json();
            if (res.ok) {
              state.status = 'æµ‹è¯•æµè¿æ¥ä¸­...';
              startStream(data.streamingId, data.streamUrl);
            } else {
              state.status = 'Error: ' + data.error;
              state.isStarting = false;
            }
          } catch (e) {
            state.status = 'æµ‹è¯•è¯·æ±‚å¤±è´¥';
            state.isStarting = false;
          }
        };

        const generatePreviewDiff = (content) => {
          const lines = content.split('\n');
          return lines.slice(0, 10).map(l => ({ type: 'add', content: '+ ' + l }));
        };

        const clearChat = () => {
          chatItems.value = [];
          state.allEvents = [];
          state.conversationEnded = false;
          state.session = ''; // æ¸…ç©º session
          stopStream();
        };

        // è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
        const toggleAutoRefresh = () => {
          state.autoRefresh.enabled = !state.autoRefresh.enabled;

          if (state.autoRefresh.enabled) {
            startAutoRefresh();
          } else {
            stopAutoRefresh();
          }
        };

        const startAutoRefresh = () => {
          if (state.autoRefresh.timerId) {
            clearInterval(state.autoRefresh.timerId);
          }

          state.autoRefresh.timerId = setInterval(() => {
            // åªæœ‰åœ¨ä¸å¤„äºå…¶ä»–æ“ä½œæ—¶æ‰æ‰§è¡Œè‡ªåŠ¨åˆ·æ–°
            if (!state.isRefreshing && !state.isStarting) {
              performAutoRefresh();
            } else {
              console.log('è·³è¿‡è‡ªåŠ¨åˆ·æ–°ï¼šæ­£åœ¨è¿›è¡Œå…¶ä»–æ“ä½œ');
            }
          }, state.autoRefresh.interval);

          console.log(`è‡ªåŠ¨åˆ·æ–°å·²å¯åŠ¨ï¼Œé—´éš”: ${state.autoRefresh.interval}ms`);
        };

        const stopAutoRefresh = () => {
          if (state.autoRefresh.timerId) {
            clearInterval(state.autoRefresh.timerId);
            state.autoRefresh.timerId = null;
          }
          console.log('è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢');
        };

        const restartAutoRefresh = () => {
          if (state.autoRefresh.enabled) {
            stopAutoRefresh();
            startAutoRefresh();
          }
        };

        const performAutoRefresh = async () => {
          console.log('æ‰§è¡Œè‡ªåŠ¨åˆ·æ–°...');
          state.autoRefresh.lastRefreshTime = new Date();

          try {
            // 1. åˆ·æ–°å¯¹è¯å†å²åˆ—è¡¨
            await loadProjects();

            // 2. å¦‚æœæœ‰é€‰ä¸­çš„å¯¹è¯ï¼Œåˆ·æ–°å…¶å†…å®¹
            if (state.selectedHistoryId) {
              const selectedHistory = chatHistory.value.find(h => h.id === state.selectedHistoryId);
              if (selectedHistory) {
                // è®°å½•åˆ·æ–°å‰çš„æ»šåŠ¨ä½ç½®
                const container = document.getElementById('chat-container');
                const wasNearBottom = container ?
                  (container.scrollHeight - container.scrollTop - container.clientHeight) <= 150 : true;

                if (selectedHistory.isRemote) {
                  // è¿œç¨‹å¯¹è¯ï¼šé‡æ–°åŠ è½½ï¼Œä¸è‡ªåŠ¨æ»šåŠ¨
                  await loadSessionConversation(selectedHistory.projectId, selectedHistory.sessionId, false);
                  // å¦‚æœåˆ·æ–°å‰åœ¨åº•éƒ¨é™„è¿‘ï¼Œåˆ·æ–°åæ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆä¿æŒå¸é™„ï¼‰
                  if (wasNearBottom) {
                    nextTick(() => scrollToBottom(true));
                  }
                } else {
                  // æœ¬åœ°å¯¹è¯ï¼šé‡æ–°åŠ è½½æ¶ˆæ¯
                  if (selectedHistory.messages && selectedHistory.messages.length > 0) {
                    chatItems.value = [...selectedHistory.messages];
                    // å¦‚æœåˆ·æ–°å‰åœ¨åº•éƒ¨é™„è¿‘ï¼Œåˆ·æ–°åæ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆä¿æŒå¸é™„ï¼‰
                    if (wasNearBottom) {
                      nextTick(() => scrollToBottom(true));
                    }
                  }
                }
              }
            }

            console.log('è‡ªåŠ¨åˆ·æ–°å®Œæˆ');
          } catch (error) {
            console.error('è‡ªåŠ¨åˆ·æ–°å¤±è´¥:', error);
          }
        };

        const manualRefresh = async () => {
          if (state.isRefreshing || state.isStarting) {
            console.log('è·³è¿‡åˆ·æ–°ï¼šæ­£åœ¨è¿›è¡Œå…¶ä»–æ“ä½œ');
            return;
          }

          state.isRefreshing = true;
          state.status = 'åˆ·æ–°ä¸­...';

          try {
            await performAutoRefresh();
            state.status = 'åˆ·æ–°å®Œæˆ';

            // 2ç§’åæ¸…é™¤çŠ¶æ€
            setTimeout(() => {
              if (state.status === 'åˆ·æ–°å®Œæˆ') {
                state.status = '';
              }
            }, 2000);
          } catch (error) {
            state.status = 'åˆ·æ–°å¤±è´¥';
            console.error('æ‰‹åŠ¨åˆ·æ–°å¤±è´¥:', error);
          } finally {
            state.isRefreshing = false;
          }
        };

        // é—´éš”ä¸‹æ‹‰èœå•æ§åˆ¶
        const toggleIntervalDropdown = () => {
          state.autoRefresh.intervalDropdownOpen = !state.autoRefresh.intervalDropdownOpen;
        };

        const closeIntervalDropdown = () => {
          state.autoRefresh.intervalDropdownOpen = false;
        };

        const selectInterval = (value) => {
          state.autoRefresh.interval = value;
          state.autoRefresh.intervalDropdownOpen = false;
          restartAutoRefresh();
        };

        const getIntervalLabel = (value) => {
          const option = intervalOptions.find(opt => opt.value === value);
          return option ? option.label : '5ç§’';
        };

        const resetChat = () => {
          clearChat();
          state.status = 'æ–°ä¼šè¯';
          state.selectedHistoryId = null; // å–æ¶ˆé€‰ä¸­å†å²è®°å½•
          state.showInputArea = true; // æ˜¾ç¤ºè¾“å…¥åŒºåŸŸ
          state.inputDisabled = false; // å¯ç”¨è¾“å…¥æ¡†ï¼ˆæ–°å¯¹è¯å¯ä»¥è¾“å…¥ï¼‰
          state.projectPathMissing = false; // é‡ç½®è·¯å¾„ç¼ºå¤±æ ‡è®°
          console.log('[resetChat] çŠ¶æ€å·²é‡ç½®', {
            showInputArea: state.showInputArea,
            inputDisabled: state.inputDisabled
          });
        };

        // å¤åˆ¶ Session ID
        const copySessionId = async () => {
          try {
            await navigator.clipboard.writeText(state.session);
            // å¯ä»¥æ·»åŠ ä¸€ä¸ªä¸´æ—¶æç¤º
            const originalStatus = state.status;
            state.status = 'âœ“ Session ID å·²å¤åˆ¶';
            setTimeout(() => {
              state.status = originalStatus;
            }, 2000);
          } catch (err) {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            state.status = 'å¤åˆ¶å¤±è´¥';
          }
        };

        const loadEventsList = async () => {
          try {
            const res = await fetch('/api/chat/events');
            const data = await res.json();
            if (res.ok) {
              eventsList.value = data.events || [];
              // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
              if (eventsList.value.length > 0 && !state.selectedEvent) {
                state.selectedEvent = eventsList.value[0].name;
              }
            }
          } catch (e) {
            console.error('Failed to load events list:', e);
          }
        };

        const toggleDropdown = () => {
          state.dropdownOpen = !state.dropdownOpen;
        };

        const closeDropdown = () => {
          state.dropdownOpen = false;
        };

        const selectEvent = (eventName) => {
          state.selectedEvent = eventName;
          state.dropdownOpen = false;
        };

        const deleteEvent = async (eventName) => {
          if (!confirm(`ç¡®å®šè¦åˆ é™¤äº‹ä»¶ "${eventName}" å—ï¼Ÿ`)) {
            return;
          }

          try {
            const res = await fetch(`/api/chat/events/${eventName}`, {
              method: 'DELETE'
            });

            const data = await res.json();
            if (res.ok) {
              state.status = `äº‹ä»¶å·²åˆ é™¤: ${eventName}`;
              // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„äº‹ä»¶ï¼Œæ¸…ç©ºé€‰æ‹©
              if (state.selectedEvent === eventName) {
                state.selectedEvent = '';
              }
              // é‡æ–°åŠ è½½äº‹ä»¶åˆ—è¡¨
              await loadEventsList();
            } else {
              state.status = `åˆ é™¤å¤±è´¥: ${data.error}`;
              alert(`åˆ é™¤å¤±è´¥: ${data.error}`);
            }
          } catch (e) {
            state.status = 'åˆ é™¤å¤±è´¥: ' + e.message;
            alert('åˆ é™¤å¤±è´¥: ' + e.message);
          }
        };

        // Save events functions
        const openSaveModal = () => {
          state.showSaveModal = true;
          state.saveEventName = '';
        };

        const closeSaveModal = () => {
          state.showSaveModal = false;
          state.saveEventName = '';
        };

        const saveEvents = async () => {
          const name = state.saveEventName.trim();
          if (!name) return;

          state.isSaving = true;
          try {
            const res = await fetch('/api/chat/events/save', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                name: name,
                events: state.allEvents
              })
            });

            const data = await res.json();
            if (res.ok) {
              state.status = `äº‹ä»¶å·²ä¿å­˜: ${name}`;
              closeSaveModal();
              // é‡æ–°åŠ è½½äº‹ä»¶åˆ—è¡¨
              await loadEventsList();
              // è‡ªåŠ¨é€‰ä¸­åˆšä¿å­˜çš„äº‹ä»¶
              state.selectedEvent = name;
            } else {
              state.status = `ä¿å­˜å¤±è´¥: ${data.error}`;
              alert(`ä¿å­˜å¤±è´¥: ${data.error}`);
            }
          } catch (e) {
            state.status = 'ä¿å­˜å¤±è´¥: ' + e.message;
            alert('ä¿å­˜å¤±è´¥: ' + e.message);
          } finally {
            state.isSaving = false;
          }
        };

        // Model dropdown functions
        const toggleModelDropdown = () => {
          state.modelDropdownOpen = !state.modelDropdownOpen;
        };

        const selectModel = (modelName) => {
          state.selectedModel = modelName;
          state.modelDropdownOpen = false;
        };

        // CWD (å·¥ä½œç›®å½•) ç›¸å…³æ–¹æ³•
        const loadCwdList = () => {
          try {
            const saved = localStorage.getItem('cwdList');
            if (saved) {
              state.cwdList = JSON.parse(saved);
              // é»˜è®¤é€‰ä¸­æœ€åä¸€æ¬¡æ·»åŠ çš„åœ°å€
              if (state.cwdList.length > 0) {
                state.currentCwd = state.cwdList[state.cwdList.length - 1];
              }
            }
          } catch (e) {
            console.error('åŠ è½½å·¥ä½œç›®å½•åˆ—è¡¨å¤±è´¥', e);
            state.cwdList = [];
          }
        };

        const saveCwdList = () => {
          try {
            localStorage.setItem('cwdList', JSON.stringify(state.cwdList));
          } catch (e) {
            console.error('ä¿å­˜å·¥ä½œç›®å½•åˆ—è¡¨å¤±è´¥', e);
          }
        };

        const toggleCwdDropdown = () => {
          state.cwdDropdownOpen = !state.cwdDropdownOpen;
        };

        const selectCwd = (cwd) => {
          state.currentCwd = cwd;
          state.cwdDropdownOpen = false;
        };

        const handleCwdInput = () => {
          // è¾“å…¥æ—¶ä¸åšä»»ä½•æ“ä½œï¼Œåªåœ¨å‘é€æ—¶ä¿å­˜
        };

        const addCwdToList = (cwd) => {
          if (!cwd || !cwd.trim()) return;

          const trimmedCwd = cwd.trim();

          // å¦‚æœå·²å­˜åœ¨ï¼Œå…ˆç§»é™¤
          const index = state.cwdList.indexOf(trimmedCwd);
          if (index > -1) {
            state.cwdList.splice(index, 1);
          }

          // æ·»åŠ åˆ°åˆ—è¡¨æœ«å°¾
          state.cwdList.push(trimmedCwd);

          // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
          saveCwdList();
        };

        const removeCwd = (index) => {
          state.cwdList.splice(index, 1);
          saveCwdList();

          // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„ï¼Œæ¸…ç©ºå½“å‰é€‰æ‹©
          if (state.currentCwd === state.cwdList[index]) {
            state.currentCwd = '';
          }
        };

        // Image upload functions
        const handleFileSelect = (e) => {
          const files = e.target.files;
          for (let file of files) {
            if (file.type.startsWith('image/')) {
              addImagePreview(file);
            }
          }
          e.target.value = '';
        };

        const addImagePreview = (file) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const imageData = {
              id: Math.random().toString(36).substr(2, 9),
              src: e.target.result,
              name: file.name
            };
            state.uploadedImages.push(imageData);
            renderImagePreviews();
          };
          reader.readAsDataURL(file);
        };

        const removeImage = (imageId) => {
          state.uploadedImages = state.uploadedImages.filter(img => img.id !== imageId);
          renderImagePreviews();
        };

        const renderImagePreviews = () => {
          const previewArea = document.getElementById('preview-area-input');
          if (!previewArea) return;

          previewArea.innerHTML = '';
          state.uploadedImages.forEach(img => {
            const wrapper = document.createElement('div');
            wrapper.className = 'preview-wrapper-input';

            const imgEl = document.createElement('img');
            imgEl.src = img.src;
            imgEl.className = 'preview-item-input';
            imgEl.onclick = () => openImageViewer(img.src); // æ·»åŠ ç‚¹å‡»é¢„è§ˆåŠŸèƒ½

            const closeBtn = document.createElement('div');
            closeBtn.className = 'preview-close-input';
            closeBtn.innerHTML = `
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            `;
            closeBtn.onclick = (e) => {
              e.stopPropagation();
              removeImage(img.id);
            };

            wrapper.appendChild(imgEl);
            wrapper.appendChild(closeBtn);
            previewArea.appendChild(wrapper);
          });
        };

        const handlePaste = (e) => {
          const items = (e.clipboardData || e.originalEvent.clipboardData).items;
          for (let item of items) {
            if (item.type.includes('image')) {
              addImagePreview(item.getAsFile());
            }
          }
        };

        const handleEnter = (e) => {
          if (!e.shiftKey) {
            e.preventDefault();
            if (canSend.value) {
              startSession();
            }
          }
        };

        const autoResize = (e) => {
          const textarea = e.target;
          textarea.style.height = 'auto';
          textarea.style.height = textarea.scrollHeight + 'px';
        };

        // å­ä»£ç†ç›¸å…³å‡½æ•°
        const openSubagent = (item) => {
          // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
          const container = document.getElementById('chat-container');
          if (container) {
            state.subagentView.scrollPosition = container.scrollTop;
          }

          // è®¾ç½®å­ä»£ç†è§†å›¾æ•°æ®
          state.subagentView.active = true;
          state.subagentView.messages = item.subagentMessages || [];
          state.subagentView.description = item.input?.description || item.input?.prompt || 'Subagent Task';

          // æ‰“å¼€å­ä»£ç†è§†å›¾åæ»šåŠ¨åˆ°åº•éƒ¨
          scrollSubagentToBottom(false);
        };

        const closeSubagent = () => {
          state.subagentView.active = false;
          state.subagentView.messages = [];
          state.subagentView.description = '';

          // æ¢å¤æ»šåŠ¨ä½ç½®
          nextTick(() => {
            const container = document.getElementById('chat-container');
            if (container) {
              container.scrollTop = state.subagentView.scrollPosition;
            }
          });
        };

        // ä¸»å¯¹è¯ï¼šå…¨éƒ¨æŠ˜å /å±•å¼€åˆ‡æ¢
        const toggleAllCollapse = () => {
          const newCollapsedState = !state.allCollapsed;
          state.allCollapsed = newCollapsedState;

          // æ›´æ–°æ‰€æœ‰å¯æŠ˜å çš„æ¶ˆæ¯é¡¹çš„æŠ˜å çŠ¶æ€
          chatItems.value.forEach(item => {
            if (item.kind === 'tool' || item.kind === 'subagent' || item.kind === 'todo_list') {
              collapseStateMap.set(item.id, newCollapsedState);
            }
          });
        };

        // å­ä»£ç†ï¼šå…¨éƒ¨æŠ˜å /å±•å¼€åˆ‡æ¢
        const toggleAllCollapseSubagent = () => {
          const newCollapsedState = !state.subagentView.allCollapsed;
          state.subagentView.allCollapsed = newCollapsedState;

          // æ›´æ–°æ‰€æœ‰å­ä»£ç†æ¶ˆæ¯ä¸­å¯æŠ˜å çš„é¡¹çš„æŠ˜å çŠ¶æ€
          state.subagentView.messages.forEach(item => {
            if (item.kind === 'tool' || item.kind === 'subagent' || item.kind === 'todo_list') {
              subagentCollapseStateMap.set(item.id, newCollapsedState);
            }
          });
        };

        const chatInput = ref(null);

        // Image viewer state
        const imageViewer = ref(null);
        const viewerImage = ref(null);
        const viewerImageWrapper = ref(null);
        const viewerClose = ref(null);
        const zoomIn = ref(null);
        const zoomOut = ref(null);
        const zoomReset = ref(null);
        const zoomLevel = ref(null);

        let currentZoom = 1;
        let currentX = 0;
        let currentY = 0;
        let isDraggingImage = false;
        let startDragX = 0;
        let startDragY = 0;

        const openImageViewer = (src) => {
          if (!imageViewer.value) return;

          viewerImage.value.src = src;
          imageViewer.value.classList.add('active');
          currentZoom = 1;
          currentX = 0;
          currentY = 0;
          updateImageTransform();
        };

        const closeImageViewer = () => {
          if (!imageViewer.value) return;

          imageViewer.value.classList.remove('active');
          viewerImage.value.src = '';
        };

        const updateImageTransform = () => {
          if (!viewerImageWrapper.value || !zoomLevel.value) return;

          viewerImageWrapper.value.style.transform = `translate(${currentX}px, ${currentY}px) scale(${currentZoom})`;
          zoomLevel.value.textContent = Math.round(currentZoom * 100) + '%';
        };

        const zoom = (delta) => {
          currentZoom = Math.max(0.5, Math.min(5, currentZoom + delta));
          updateImageTransform();
        };

        const setupImageViewer = () => {
          imageViewer.value = document.getElementById('image-viewer');
          viewerImage.value = document.getElementById('viewer-image');
          viewerImageWrapper.value = document.getElementById('viewer-image-wrapper');
          viewerClose.value = document.getElementById('viewer-close');
          zoomIn.value = document.getElementById('zoom-in');
          zoomOut.value = document.getElementById('zoom-out');
          zoomReset.value = document.getElementById('zoom-reset');
          zoomLevel.value = document.getElementById('zoom-level');

          if (!imageViewer.value) return;

          // Close button
          viewerClose.value.onclick = closeImageViewer;

          // Zoom controls
          zoomIn.value.onclick = () => zoom(0.5);
          zoomOut.value.onclick = () => zoom(-0.5);
          zoomReset.value.onclick = () => {
            currentZoom = 1;
            currentX = 0;
            currentY = 0;
            updateImageTransform();
          };

          // ESC to close
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
              // ä¼˜å…ˆå…³é—­å›¾ç‰‡æŸ¥çœ‹å™¨
              if (imageViewer.value.classList.contains('active')) {
                closeImageViewer();
              }
              // å¦‚æœå­ä»£ç†è§†å›¾æ‰“å¼€ï¼Œåˆ™å…³é—­å­ä»£ç†è§†å›¾
              else if (state.subagentView.active) {
                closeSubagent();
              }
            }
          });

          // Drag to pan
          viewerImageWrapper.value.addEventListener('mousedown', (e) => {
            isDraggingImage = true;
            startDragX = e.clientX - currentX;
            startDragY = e.clientY - currentY;
            e.preventDefault();
          });

          document.addEventListener('mousemove', (e) => {
            if (isDraggingImage) {
              currentX = e.clientX - startDragX;
              currentY = e.clientY - startDragY;
              updateImageTransform();
            }
          });

          document.addEventListener('mouseup', () => {
            if (isDraggingImage) {
              isDraggingImage = false;
            }
          });

          // Mouse wheel zoom
          imageViewer.value.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            zoom(delta);
          });
        };

        // ç›‘å¬å­ä»£ç†æ¶ˆæ¯å˜åŒ–ï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        watch(() => state.subagentView.messages.length, () => {
          if (state.subagentView.active) {
            scrollSubagentToBottom(true);
          }
        });

        // ç›‘å¬å¯¹è¯å†å²å˜åŒ–ï¼Œè‡ªåŠ¨æ»šåŠ¨ä¾§è¾¹æ åˆ°åº•éƒ¨
        watch(() => chatHistory.value.length, () => {
          scrollSidebarToBottom(true);
        });

        watch(() => state.message, (newVal) => {
          if (newVal === '' && chatInput.value) {
            chatInput.value.style.height = 'auto';
          }
        });

        // Close dropdowns when clicking outside
        const handleClickOutside = (e) => {
          if (state.modelDropdownOpen) {
            state.modelDropdownOpen = false;
          }
          if (state.cwdDropdownOpen) {
            state.cwdDropdownOpen = false;
          }
        };

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†çš„æŒ‡ä»¤
        const clickOutsideDirective = {
          mounted(el, binding) {
            el.clickOutsideEvent = (event) => {
              if (!(el === event.target || el.contains(event.target))) {
                binding.value();
              }
            };
            document.addEventListener('click', el.clickOutsideEvent);
          },
          unmounted(el) {
            document.removeEventListener('click', el.clickOutsideEvent);
          }
        };

        // åŠ è½½é»˜è®¤å¯¹è¯æ•°æ®
        const loadDefaultConversation = () => {
          chatItems.value = [...defaultConversation];
          scrollToBottom(false); // åˆå§‹åŠ è½½æ—¶ä¸ä½¿ç”¨å¹³æ»‘æ»šåŠ¨
        };

        // åŠ è½½é¡¹ç›®åˆ—è¡¨
        const loadProjects = async () => {
          try {
            const response = await fetch('/api/chat/projects');
            const data = await response.json();

            if (data.projects && data.projects.length > 0) {
              // å°†é¡¹ç›®ä¼šè¯æ·»åŠ åˆ°å¯¹è¯å†å²åˆ—è¡¨
              chatHistory.value = [];

              data.projects.forEach(project => {
                if (project.sessions && project.sessions.length > 0) {
                  project.sessions.forEach(session => {
                    chatHistory.value.push({
                      id: `${project.id}/${session.id}`,
                      title: session.title || `${project.name} - ${session.id}`,
                      isRemote: true, // æ ‡è®°ä¸ºè¿œç¨‹æ•°æ®
                      projectId: project.id,
                      sessionId: session.id,
                      messages: [] // è¿œç¨‹æ•°æ®ä¸é¢„åŠ è½½æ¶ˆæ¯
                    });
                  });
                }
              });
              return
            }

            // å¦‚æœæ²¡æœ‰é¡¹ç›®æˆ–ä¼šè¯ï¼ŒåŠ è½½é»˜è®¤å¯¹è¯
            showErrorMessage('åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥');
          } catch (error) {
            showErrorMessage('åŠ è½½é¡¹ç›®åˆ—è¡¨æŠ¥é”™', error);
          }
        };

        // åŠ è½½ä¼šè¯å¯¹è¯å†…å®¹
        // åŠ è½½ä¼šè¯å¯¹è¯å†…å®¹
        const loadSessionConversation = async (projectId, sessionId, shouldScroll = true) => {
          try {
            console.log('[loadSessionConversation] å¼€å§‹åŠ è½½ä¼šè¯', { projectId, sessionId });
            const response = await fetch(`/api/chat/projects/${projectId}/sessions/${sessionId}`);
            const data = await response.json();

            if (data.conversation && data.conversation.length > 0) {
              chatItems.value = data.conversation;
              // è®¾ç½®å½“å‰ session IDï¼Œä»¥ä¾¿ç»§ç»­å¯¹è¯
              state.session = sessionId;
              // è®¾ç½®é¡¹ç›®è·¯å¾„åˆ° currentCwd
              state.currentCwd = data.projectPath || '';
              state.projectPathMissing = !data.projectPath; // æ ‡è®°è·¯å¾„æ˜¯å¦ç¼ºå¤±
              // æ˜¾ç¤ºè¾“å…¥æ¡†ï¼Œæ ‡è®°ä¸ºå·²å­˜åœ¨çš„ä¼šè¯ï¼ˆç”¨äºæ˜¾ç¤ºæç¤ºå›¾æ ‡ï¼‰
              state.showInputArea = true;
              state.inputDisabled = true; // æ ‡è®°ä¸ºå·²å­˜åœ¨çš„ä¼šè¯ï¼ˆç”¨äºæ˜¾ç¤ºæç¤ºå›¾æ ‡ï¼‰
              console.log('[loadSessionConversation] çŠ¶æ€å·²æ›´æ–°', {
                showInputArea: state.showInputArea,
                inputDisabled: state.inputDisabled,
                session: state.session,
                projectPath: data.projectPath,
                currentCwd: state.currentCwd,
                projectPathMissing: state.projectPathMissing
              });
              console.log(`Loaded ${data.conversation.length} messages from ${projectId}/${sessionId}`);
              console.log('Session ID set to:', sessionId);
              // æ ¹æ®å‚æ•°å†³å®šæ˜¯å¦æ»šåŠ¨
              if (shouldScroll) {
                scrollToBottom(false); // åŠ è½½ä¼šè¯æ—¶ä¸ä½¿ç”¨å¹³æ»‘æ»šåŠ¨
              }
            } else {
              showErrorMessage('åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥');
            }
          } catch (error) {
            console.error('[loadSessionConversation] é”™è¯¯', error);
            showErrorMessage('åŠ è½½ä¼šè¯å¯¹è¯æŠ¥é”™', error);
          }
        };

        // åŠ è½½å†å²å¯¹è¯
        const loadHistoryConversation = async (historyItem) => {
          // åŒºåˆ†æ˜¯å¦æ˜¯è¿œç¨‹æ•°æ®
          if (historyItem.isRemote) {
            // è¿œç¨‹æ•°æ®ï¼šé€šè¿‡ API è·å–é¡¹ç›®ä¼šè¯è¯¦æƒ…
            console.log('Loading remote conversation:', {
              projectId: historyItem.projectId,
              sessionId: historyItem.sessionId
            });

            await loadSessionConversation(historyItem.projectId, historyItem.sessionId);
            state.selectedHistoryId = historyItem.id;
          } else {
            // æœ¬åœ°æ•°æ®ï¼šç›´æ¥åŠ è½½æ¶ˆæ¯
            if (historyItem.messages && historyItem.messages.length > 0) {
              chatItems.value = [...historyItem.messages];
              state.selectedHistoryId = historyItem.id;
              scrollToBottom(false); // åŠ è½½å†å²è®°å½•æ—¶ä¸ä½¿ç”¨å¹³æ»‘æ»šåŠ¨
            }
          }
        };

        // åˆ é™¤é¡¹ç›®
        // åˆ é™¤ sessionï¼ˆä¼šè¯ï¼‰
        const deleteSession = async (sessionId) => {
          if (!confirm(`ç¡®å®šè¦åˆ é™¤ä¼šè¯ "${sessionId}" å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤è¯¥ä¼šè¯çš„æ‰€æœ‰è®°å½•å’Œç›¸å…³æ–‡ä»¶ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
            return;
          }

          try {
            state.status = 'åˆ é™¤ä¸­...';
            const response = await fetch(`/api/chat/sessions/${sessionId}`, {
              method: 'DELETE'
            });

            const data = await response.json();

            if (response.ok) {
              state.status = `ä¼šè¯å·²åˆ é™¤: ${sessionId}`;

              // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„ä¼šè¯ï¼Œæ¸…ç©ºå¯¹è¯
              const deletedHistoryIds = chatHistory.value
                .filter(h => h.sessionId === sessionId)
                .map(h => h.id);

              if (deletedHistoryIds.includes(state.selectedHistoryId)) {
                clearChat();
                state.selectedHistoryId = null;
              }

              // é‡æ–°åŠ è½½é¡¹ç›®åˆ—è¡¨
              await loadProjects();

              // å¦‚æœè¿˜æœ‰å…¶ä»–ä¼šè¯ï¼ŒåŠ è½½ç¬¬ä¸€ä¸ª
              if (chatHistory.value.length > 0 && !state.selectedHistoryId) {
                await loadHistoryConversation(chatHistory.value[0]);
              }

              // 2ç§’åæ¸…é™¤çŠ¶æ€
              setTimeout(() => {
                if (state.status === `ä¼šè¯å·²åˆ é™¤: ${sessionId}`) {
                  state.status = '';
                }
              }, 2000);
            } else {
              state.status = `åˆ é™¤å¤±è´¥: ${data.error}`;
              alert(`åˆ é™¤å¤±è´¥: ${data.error}`);
            }
          } catch (error) {
            state.status = 'åˆ é™¤å¤±è´¥: ' + error.message;
            alert('åˆ é™¤å¤±è´¥: ' + error.message);
            console.error('åˆ é™¤ä¼šè¯å¤±è´¥:', error);
          }
        };

        onMounted(() => {
          loadEventsList();
          loadCwdList(); // åŠ è½½å·¥ä½œç›®å½•åˆ—è¡¨
          setupImageViewer();
          document.addEventListener('click', handleClickOutside);
          // å°è¯•åŠ è½½é¡¹ç›®å¯¹è¯ï¼Œå¦‚æœå¤±è´¥åˆ™åŠ è½½é»˜è®¤å¯¹è¯
          loadProjects().then(() => {
            // åŠ è½½ç¬¬ä¸€ä¸ªå†å²å¯¹è¯
            if (chatHistory.value.length > 0) {
              loadHistoryConversation(chatHistory.value[0]);
            }
          });
        });

        onBeforeUnmount(() => {
          document.removeEventListener('click', handleClickOutside);
          // æ¸…ç†è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
          stopAutoRefresh();
        });

        return {
          state, chatItems, chatHistory, groupedMessages, subagentGroupedMessages, eventsList, modelOptions, canSend, showSaveButton,
          intervalOptions,
          startSession, abortSession, sendTestRequest, clearChat, resetChat, copySessionId,
          approvePermission, denyPermission, toggleToolCollapse, isCollapsed,
          toggleDropdown, closeDropdown, selectEvent, deleteEvent,
          toggleModelDropdown, selectModel,
          toggleCwdDropdown, selectCwd, handleCwdInput, removeCwd,
          handleFileSelect, handlePaste, handleEnter, autoResize, chatInput,
          openSaveModal, closeSaveModal, saveEvents,
          loadHistoryConversation, deleteSession,
          openSubagent, closeSubagent,
          toggleAllCollapse, toggleAllCollapseSubagent,
          scrollToBottom, smartScrollToBottom, scrollSidebarToBottom, scrollSubagentToBottom,
          toggleAutoRefresh, manualRefresh, restartAutoRefresh,
          toggleIntervalDropdown, closeIntervalDropdown, selectInterval, getIntervalLabel
        };
      },
      directives: {
        clickOutside: {
          mounted(el, binding) {
            el.clickOutsideEvent = (event) => {
              if (!(el === event.target || el.contains(event.target))) {
                binding.value();
              }
            };
            document.addEventListener('click', el.clickOutsideEvent);
          },
          unmounted(el) {
            document.removeEventListener('click', el.clickOutsideEvent);
          }
        }
      }
    }).mount('#app');
  </script>

  <!-- æ¶ˆæ¯æ¸²æŸ“ç»„ä»¶æ¨¡æ¿ -->
  <script type="text/x-template" id="message-renderer-template">
    <div>
      <!-- ç”¨æˆ·æ¶ˆæ¯ -->
      <div v-if="group.role === 'user'" class="flex gap-4 max-w-4xl mx-auto flex-row-reverse">
        <div class="w-8 h-8 rounded-lg flex-shrink-0 flex items-center justify-center mt-1 bg-blue-600 text-white">
          <i class="fa-solid fa-user"></i>
        </div>
        <div class="flex-1 flex flex-col gap-2 items-end">
          <div class="prose prose-slate max-w-full px-4 py-3 rounded-2xl shadow-sm bg-blue-600 text-white prose-invert"
            v-html="group.html"></div>
          <span class="text-[10px] text-slate-400 px-1">{{ group.time }}</span>
        </div>
      </div>

      <!-- AI æ¶ˆæ¯ç»„ -->
      <div v-if="group.role === 'assistant'" class="flex gap-4 max-w-4xl mx-auto">
        <div class="w-8 h-8 rounded-lg flex-shrink-0 flex items-center justify-center bg-gradient-to-br text-white shadow-sm"
          :class="isSubagent ? 'from-purple-500 to-purple-600' : 'from-blue-500 to-blue-600'">
          <i class="fa-solid fa-robot"></i>
        </div>
        <div class="flex-1 bg-white shadow-xs rounded-xl p-4 space-y-3 overflow-hidden">
          <template v-for="item in group.items" :key="item.id">
            <!-- æ–‡æœ¬å†…å®¹ -->
            <div v-if="item.kind === 'text'" class="assistant-text text-slate-800" v-html="item.html"></div>

            <!-- å·¥å…·è°ƒç”¨å¡ç‰‡ -->
            <div v-if="item.kind === 'tool'" class="w-full">
              <div class="bg-white border rounded-lg shadow-sm overflow-hidden" :class="[
                isCollapsed(item.id, isSubagent) ? 'tool-collapsed' : '',
                item.isError ? 'border-red-300 bg-red-50' : 'border-slate-200'
              ]">
                <div @click="$emit('toggle-collapse', item)"
                  class="px-4 py-2.5 border-b flex justify-between items-center cursor-pointer transition select-none"
                  :class="item.isError ? 'bg-red-50 border-red-200 hover:bg-red-100' : 'bg-slate-50 border-slate-200 hover:bg-slate-100'">
                  <div class="flex items-center gap-2 flex-1 min-w-0">
                    <i class="fa-solid fa-chevron-down tool-collapse-btn flex-shrink-0"
                      :class="item.isError ? 'text-red-400' : 'text-slate-400'"></i>
                    <span class="text-xs font-semibold flex-shrink-0"
                      :class="item.isError ? 'text-red-700' : 'text-slate-700'">{{ item.name }}</span>
                    <span v-if="isCollapsed(item.id, isSubagent) && item.name === 'Bash' && item.input?.command"
                      class="text-xs font-mono truncate max-w-md"
                      :class="item.isError ? 'text-red-600' : 'text-slate-500'">
                      {{ item.input.command }}
                    </span>
                    <span v-else-if="item.input?.path || item.input?.file_path"
                      class="text-[10px] font-mono truncate max-w-md"
                      :class="item.isError ? 'text-red-500' : 'text-slate-400'">
                      {{ item.input.path || item.input.file_path }}
                    </span>
                    <span v-if="isCollapsed(item.id, isSubagent) && item.name !== 'Bash'&& Object.keys(item.input).length > 0"
                      class="text-[10px] font-mono truncate max-w-md"
                      :class="item.isError ? 'text-red-500' : 'text-slate-400'">
                      {{ item.input }}
                    </span>
                  </div>
                  <div class="flex items-center gap-2 flex-shrink-0">
                    <span v-if="item.isError"
                      class="text-[10px] bg-red-600 text-white px-2 py-0.5 rounded font-bold flex items-center gap-1">
                      <i class="fa-solid fa-circle-exclamation"></i> ERROR
                    </span>
                    <span v-else-if="item.result"
                      class="text-[10px] bg-green-600 text-white px-2 py-0.5 rounded font-bold flex items-center gap-1">
                      <i class="fa-solid fa-circle-check"></i> SUCCESS
                    </span>
                    <span v-else
                      class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold">TOOL</span>
                  </div>
                </div>

                <div v-show="!isCollapsed(item.id, isSubagent)">
                  <div class="px-3 font-mono text-xs border-b"
                    :class="item.isError ? 'bg-red-100 text-red-800 border-red-200' : 'bg-slate-100 text-slate-700 border-slate-200'">
                    <div v-if="item.name === 'Bash'" class="py-3"
                      :class="item.isError ? 'text-red-900' : 'text-slate-800'">{{ item.input?.command }}</div>
                    <div v-else-if="item.name === 'Write'"></div>
                    <div v-else class="py-3">{{ JSON.stringify(item.input) }}</div>
                  </div>

                  <div class="p-3 text-xs font-mono max-h-64 overflow-y-auto custom-scrollbar"
                    :class="item.isError ? 'bg-red-50' : 'bg-white'">
                    <div v-if="item.isError"
                      class="bg-red-100 border-l-4 border-red-600 px-3 py-2 mb-2 rounded flex items-start gap-2">
                      <i class="fa-solid fa-circle-xmark text-red-700 flex-shrink-0 mt-0.5"></i>
                      <span class="text-red-800 font-semibold">æ‰§è¡Œé”™è¯¯</span>
                    </div>
                    <div v-if="item.diffLines">
                      <div v-for="(line, idx) in item.diffLines" :key="idx"
                        :class="line.type === 'add' ? 'diff-added' : line.type === 'rem' ? 'diff-removed' : 'text-slate-500'"
                        class="px-2 py-0.5">
                        {{ line.content }}
                      </div>
                    </div>
                    <pre v-else
                      :class="item.isError ? 'text-red-700' : 'text-slate-600'">{{ item.result || 'æ‰§è¡Œä¸­...' }}</pre>
                  </div>
                </div>
              </div>
            </div>

            <!-- æƒé™å®¡æ‰¹ UI -->
            <div v-if="item.kind === 'permission_request'" class="w-full">
              <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                <div class="flex gap-3">
                  <div
                    class="w-10 h-10 bg-amber-100 rounded-full flex items-center justify-center text-amber-600 flex-shrink-0">
                    <i class="fa-solid fa-shield-halved text-lg"></i>
                  </div>
                  <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-bold text-amber-800 flex items-center gap-2">
                      <i class="fa-solid fa-lock"></i>
                      æ“ä½œæƒé™è¯·æ±‚: {{ item.toolName }}
                    </h4>
                    <div
                      class="bg-white/50 rounded p-2 mt-2 font-mono text-[10px] text-slate-600 border border-amber-100 max-h-64 overflow-auto custom-scrollbar">
                      <pre
                        class="whitespace-pre-wrap break-words">{{ JSON.stringify(item.toolInput || item.payload, null, 2) }}</pre>
                    </div>
                    <div class="mt-4 flex gap-2">
                      <button @click="$emit('approve-permission', item)"
                        class="px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg text-xs font-bold transition flex items-center gap-1.5">
                        <i class="fa-solid fa-check"></i> å…è®¸æ‰§è¡Œ
                      </button>
                      <button @click="$emit('deny-permission', item)"
                        class="px-4 py-2 bg-white border border-amber-300 hover:bg-amber-50 text-amber-700 rounded-lg text-xs font-bold transition flex items-center gap-1.5">
                        <i class="fa-solid fa-xmark"></i> æ‹’ç»
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- å­ä»£ç†å¡ç‰‡ -->
            <div v-if="item.kind === 'subagent'" class="w-full">
              <div class="bg-white border rounded-lg shadow-sm overflow-hidden" :class="[
                isCollapsed(item.id, isSubagent) ? 'tool-collapsed' : '',
                item.isError ? 'border-red-300 bg-red-50' : 'border-purple-200'
              ]">
                <div @click="$emit('toggle-collapse', item)"
                  class="px-4 py-2.5 border-b flex justify-between items-center cursor-pointer transition select-none"
                  :class="item.isError ? 'bg-red-50 border-red-200 hover:bg-red-100' : 'bg-purple-50 border-purple-200 hover:bg-purple-100'">
                  <div class="flex items-center gap-2 flex-1 min-w-0">
                    <i class="fa-solid fa-chevron-down tool-collapse-btn flex-shrink-0"
                      :class="item.isError ? 'text-red-400' : 'text-purple-400'"></i>
                    <i class="fa-solid fa-robot flex-shrink-0"
                      :class="item.isError ? 'text-red-600' : 'text-purple-600'"></i>
                    <span class="text-xs font-semibold flex-shrink-0"
                      :class="item.isError ? 'text-red-700' : 'text-purple-700'">Agent</span>
                    <span v-if="isCollapsed(item.id, isSubagent) && item.input?.description"
                      class="text-xs font-mono truncate max-w-md"
                      :class="item.isError ? 'text-red-600' : 'text-purple-600'">
                      {{ item.input.description }}
                    </span>
                  </div>
                  <div class="flex items-center gap-2 flex-shrink-0">
                    <button v-if="item.subagentMessages && item.subagentMessages.length > 0"
                      @click.stop="$emit('open-subagent', item)"
                      class="text-xs px-2 py-1 rounded transition flex items-center gap-1"
                      :class="item.isError ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-purple-600 hover:bg-purple-700 text-white'"
                      title="æ‰“å¼€å­ä»£ç†å¯¹è¯">
                      <i class="fa-solid fa-arrow-up-right-from-square"></i>
                      <span>æ‰“å¼€</span>
                    </button>
                    <span v-if="item.isError"
                      class="text-[10px] bg-red-600 text-white px-2 py-0.5 rounded font-bold flex items-center gap-1">
                      <i class="fa-solid fa-circle-exclamation"></i> ERROR
                    </span>
                    <span v-else-if="item.result"
                      class="text-[10px] bg-green-600 text-white px-2 py-0.5 rounded font-bold flex items-center gap-1">
                      <i class="fa-solid fa-circle-check"></i> SUCCESS
                    </span>
                    <span v-else
                      class="text-[10px] bg-purple-100 text-purple-700 px-2 py-0.5 rounded font-bold">AGENT</span>
                  </div>
                </div>

                <div v-show="!isCollapsed(item.id, isSubagent)">
                  <div class="px-3 py-3 font-mono text-xs border-b"
                    :class="item.isError ? 'bg-red-100 text-red-800 border-red-200' : 'bg-purple-50 text-purple-800 border-purple-200'">
                    <div class="mb-2">
                      <span class="font-bold">æè¿°:</span> {{ item.input?.description || 'N/A' }}
                    </div>
                    <div class="mb-2">
                      <span class="font-bold">ç±»å‹:</span> {{ item.input?.subagent_type || 'N/A' }}
                    </div>
                    <div>
                      <span class="font-bold">æç¤º:</span> {{ item.input?.prompt || 'N/A' }}
                    </div>
                  </div>

                  <div class="p-3 text-xs font-mono max-h-64 overflow-y-auto custom-scrollbar"
                    :class="item.isError ? 'bg-red-50' : 'bg-white'">
                    <div v-if="item.isError"
                      class="bg-red-100 border-l-4 border-red-600 px-3 py-2 mb-2 rounded flex items-start gap-2">
                      <i class="fa-solid fa-circle-xmark text-red-700 flex-shrink-0 mt-0.5"></i>
                      <span class="text-red-800 font-semibold">æ‰§è¡Œé”™è¯¯</span>
                    </div>

                    <div v-if="item.subagentMessages && item.subagentMessages.length > 0"
                      class="bg-purple-50 border-l-4 border-purple-500 px-3 py-2 rounded flex items-start gap-2 mb-3">
                      <i class="fa-solid fa-comments text-purple-600 flex-shrink-0 mt-0.5"></i>
                      <div class="flex-1">
                        <div class="text-purple-800 font-semibold mb-1">å­ä»£ç†å¯¹è¯ ({{ item.subagentMessages.length }}
                          æ¡æ¶ˆæ¯)</div>
                        <div class="text-purple-600 text-[11px]">ç‚¹å‡»ä¸Šæ–¹"æ‰“å¼€"æŒ‰é’®æŸ¥çœ‹å®Œæ•´å¯¹è¯</div>
                      </div>
                    </div>

                    <div v-if="item.result">
                      <div class="text-slate-500 font-semibold mb-2 text-[11px] uppercase tracking-wide">è¿”å›ç»“æœ:
                      </div>
                      <pre class="whitespace-pre-wrap break-words"
                        :class="item.isError ? 'text-red-700' : 'text-slate-700'">{{ item.result }}</pre>
                    </div>
                    <div v-else-if="!item.subagentMessages || item.subagentMessages.length === 0">
                      <pre class="text-slate-400">æ‰§è¡Œä¸­...</pre>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- TODO åˆ—è¡¨å¡ç‰‡ -->
            <div v-if="item.kind === 'todo_list'" class="w-full">
              <div class="bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden"
                :class="{ 'tool-collapsed': isCollapsed(item.id, isSubagent) }">
                <div @click="$emit('toggle-collapse', item)"
                  class="bg-slate-50 px-4 py-2.5 border-b border-slate-200 flex justify-between items-center cursor-pointer hover:bg-slate-100 transition select-none">
                  <div class="flex items-center gap-2 flex-1 min-w-0">
                    <i class="fa-solid fa-chevron-down text-slate-400 tool-collapse-btn flex-shrink-0"></i>
                    <span class="text-xs font-semibold text-slate-700 flex-shrink-0">ä»»åŠ¡åˆ—è¡¨</span>
                    <span class="text-[10px] text-slate-400 font-semibold truncate max-w-md">{{
                      item.todos.length }} é¡¹</span>
                  </div>
                  <div class="flex items-center gap-2 flex-shrink-0">
                    <span
                      class="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded font-bold">TOOL</span>
                  </div>
                </div>

                <div v-show="!isCollapsed(item.id, isSubagent)">
                  <div class="p-3 text-xs max-h-64 overflow-y-auto custom-scrollbar bg-white">
                    <div v-for="todo in item.todos" :key="todo.id" class="mb-2 last:mb-0">
                      <div class="flex items-center gap-2 p-2 rounded hover:bg-slate-50 transition">
                        <span class="w-2 h-2 rounded-full flex-shrink-0"
                          :class="todo.status === 'completed' ? 'bg-green-500' : todo.status === 'in_progress' ? 'bg-blue-500' : 'bg-slate-300'"></span>
                        <div class="font-medium text-slate-800 flex-shrink-0"
                          :class="{ 'line-through text-slate-400': todo.status === 'completed' }">
                          {{ todo.content }}
                        </div>
                        <div v-if="todo.activeForm" class="text-[11px] text-slate-400 truncate flex-1 min-w-0"
                          :title="todo.activeForm">
                          {{ todo.activeForm }}
                        </div>
                        <span class="text-[10px] px-1.5 py-0.5 rounded flex-shrink-0 ml-auto" :class="{
                          'bg-green-100 text-green-700': todo.status === 'completed',
                          'bg-blue-100 text-blue-700': todo.status === 'in_progress',
                          'bg-slate-100 text-slate-600': todo.status === 'pending'
                        }">
                          {{ todo.status === 'completed' ? 'å®Œæˆ' : todo.status === 'in_progress' ? 'è¿›è¡Œä¸­' : 'å¾…å¤„ç†'
                          }}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </template>

          <!-- æ—¶é—´æˆ³å’Œä¿å­˜æŒ‰é’® -->
          <div class="text-[10px] text-slate-400 pt-1 flex items-center gap-2">
            <span>{{ group.time }}</span>
            <slot name="actions"></slot>
          </div>
        </div>
      </div>
    </div>
  </script>
</body>

</html>