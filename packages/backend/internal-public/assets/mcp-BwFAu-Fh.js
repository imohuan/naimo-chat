import{Vn as e,n as t,w as n}from"./index-urHyhAmF.js";import{t as r}from"./useLlmApi-e_L-gZNA.js";function i(){let{baseUrl:e,endpoint:t}=r();async function n(e,n={}){let r=`${t.value}${e}`,i={};n.body&&(i[`Content-Type`]=`application/json`);let a=await fetch(r,{...n,headers:{...i,...n.headers}}),o=await a.json();if(!a.ok){let e=o?.error||o?.message||`请求失败`;throw Error(e)}return o}async function i(){return await n(`/api/mcp/servers`)}async function a(e){return await n(`/api/mcp/servers/${encodeURIComponent(e)}`)}async function o(e,t){await n(`/api/mcp/servers`,{method:`POST`,body:JSON.stringify({name:e,config:t})})}async function s(e,t){return await n(`/api/mcp/servers/${encodeURIComponent(e)}`,{method:`PUT`,body:JSON.stringify({config:t})})}async function c(e){await n(`/api/mcp/servers/${encodeURIComponent(e)}`,{method:`DELETE`})}async function l(e,n,r){return new Promise((n,i)=>{r||=`mcp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;let a=Date.now(),o=null,s=null,c=!1,l=()=>{o&&=(o.close(),null),s&&=(clearTimeout(s),null)};s=setTimeout(()=>{l(),i(Error(`获取工具列表超时（10秒内未收到响应）`))},1e4);try{let s=`${t.value}/mcp/${e}?sessionId=${r}`;o=new EventSource(s),o.onopen=()=>{console.log(`SSE 连接已建立: ${e}`),c||(c=!0,u(e,r,a).catch(e=>{l(),i(Error(`发送请求失败: ${e.message}`))}))};let d=e=>{try{let t=JSON.parse(e.data);t.id===a&&t.result&&(t.result.tools&&Array.isArray(t.result.tools)?(l(),n(t.result.tools)):t.error&&(l(),i(Error(t.error.message||`获取工具列表失败`))))}catch(e){console.warn(`解析 SSE 消息失败:`,e)}};o.onmessage=d,[`response`,`data`,`jsonrpc`,`result`].forEach(e=>{o.addEventListener(e,d)}),o.onerror=e=>{console.error(`SSE 连接错误:`,e),o?.readyState===EventSource.CLOSED&&(l(),i(Error(`SSE 连接已关闭`)))}}catch(e){l(),i(e)}})}async function u(e,n,r){let i=new AbortController,a=setTimeout(()=>{i.abort()},3e3);try{let o=await fetch(`${t.value}/mcp/${e}/messages`,{method:`POST`,headers:{"Content-Type":`application/json`,"mcp-session-id":n},body:JSON.stringify({jsonrpc:`2.0`,method:`tools/list`,id:r}),signal:i.signal});if(clearTimeout(a),!o.ok){let e=await o.text();throw Error(`发送请求失败: ${o.status} - ${e}`)}console.log(`tools/list 请求已发送，等待 SSE 响应...`)}catch(e){if(clearTimeout(a),e.name===`AbortError`)console.log(`请求已提交（超时是正常的），等待 SSE 响应...`);else throw e}}async function d(e,n,r,i,a){return new Promise((i,o)=>{a||=`mcp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;let s=Date.now(),c=null,l=null,u=!1,d=()=>{c&&=(c.close(),null),l&&=(clearTimeout(l),null)};l=setTimeout(()=>{d(),o(Error(`工具调用超时（30秒内未收到响应）`))},3e4);try{let l=`${t.value}/mcp/${e}?sessionId=${a}`;c=new EventSource(l),c.onopen=()=>{console.log(`SSE 连接已建立: ${e}`),u||(u=!0,f(e,a,n,r,s).catch(e=>{d(),o(Error(`发送请求失败: ${e.message}`))}))};let p=e=>{try{let t=JSON.parse(e.data);t.id===s&&(t.result===void 0?t.error&&(d(),o(Error(t.error.message||`工具调用失败`))):(d(),i(t.result)))}catch(e){console.warn(`解析 SSE 消息失败:`,e)}};c.onmessage=p,[`response`,`data`,`jsonrpc`,`result`].forEach(e=>{c.addEventListener(e,p)}),c.onerror=e=>{console.error(`SSE 连接错误:`,e),c?.readyState===EventSource.CLOSED&&(d(),o(Error(`SSE 连接已关闭`)))}}catch(e){d(),o(e)}})}async function f(e,n,r,i,a){let o=new AbortController,s=setTimeout(()=>{o.abort()},3e3);try{let c=await fetch(`${t.value}/mcp/${e}/messages`,{method:`POST`,headers:{"Content-Type":`application/json`,"mcp-session-id":n},body:JSON.stringify({jsonrpc:`2.0`,method:`tools/call`,id:a,params:{name:r,arguments:i}}),signal:o.signal});if(clearTimeout(s),!c.ok){let e=await c.text();throw Error(`发送请求失败: ${c.status} - ${e}`)}console.log(`tools/call 请求已发送，等待 SSE 响应...`)}catch(e){if(clearTimeout(s),e.name===`AbortError`)console.log(`请求已提交（超时是正常的），等待 SSE 响应...`);else throw e}}return{baseUrl:e,endpoint:t,fetchServers:i,fetchServer:a,createServer:o,updateServer:s,deleteServer:c,fetchTools:l,callTool:d}}const a=t(`mcp`,()=>{let{pushToast:t}=n(),{fetchServers:a,updateServer:o,deleteServer:s}=i(),{fetchConfig:c,fetchMcpServerTools:l,refreshMcpServerTools:u}=r(),d=e([]),f=e(!1),p=e({}),m=e({}),h=e({}),g=e(!1),_=e(``);async function v(){try{let e=(await c()).MCPRouterApiKey||``;g.value=!!(e&&e.trim()),_.value=e||``}catch(e){console.error(`检查 API Key 配置失败:`,e),g.value=!1,_.value=``}}async function y(){try{f.value=!0;let e=await a();d.value=Object.entries(e).map(([e,t])=>({name:e,config:t}));for(let e of d.value)e.config.enabled!==!1&&await b(e.name)}catch(e){t(`加载服务器列表失败: ${e.message}`,`error`)}finally{f.value=!1}}async function b(e){try{m.value[e]=!0,p.value[e]=[];let t=await l(e);p.value[e]=t}catch(n){console.error(`加载工具列表失败 (${e}):`,n),p.value[e]=[],t(`加载工具列表失败 (${e}): ${n.message}`,`error`)}finally{m.value[e]=!1}}async function x(){try{for(let e of d.value)if(e.config.enabled!==!1)try{m.value[e.name]=!0;let t=await u(e.name);p.value[e.name]=t}catch(t){console.error(`刷新工具列表失败 (${e.name}):`,t),await b(e.name)}finally{m.value[e.name]=!1}t(`已刷新所有工具列表`,`success`)}catch(e){t(`刷新工具列表失败: ${e.message}`,`error`)}}async function S(e){h.value[e.name]=!0;try{let n=e.config,r={...n,enabled:n.enabled===!1},i=await o(e.name,r),a=i.config||r,s=d.value.findIndex(t=>t.name===e.name);s!==-1&&d.value[s]&&(d.value[s].config=a),i.success?(a.enabled===!1?delete p.value[e.name]:await b(e.name),t(`服务器已${a.enabled===!1?`禁用`:`启用`}`,`success`)):(delete p.value[e.name],t(`启用失败: ${i.error||`连接失败`}`,`error`))}catch(e){t(`操作失败: ${e.message}`,`error`)}finally{h.value[e.name]=!1}}async function C(e){try{await s(e.name);let n=d.value.findIndex(t=>t.name===e.name);n!==-1&&d.value.splice(n,1),delete p.value[e.name],delete m.value[e.name],t(`服务器已删除`,`success`)}catch(e){t(`删除失败: ${e.message}`,`error`)}}return{servers:d,isLoading:f,serverTools:p,serverToolsLoading:m,serverToggleLoading:h,hasApiKey:g,mcpRouterApiKey:_,checkApiKey:v,loadServers:y,loadToolsForServer:b,refreshAllTools:x,handleToggleServer:S,handleDeleteServer:C}});export{i as n,a as t};