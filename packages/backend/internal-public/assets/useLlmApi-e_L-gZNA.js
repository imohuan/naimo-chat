import{Kt as e,Vn as t}from"./index-urHyhAmF.js";var n=`llm_base_url`,r=`llm_temp_api_key`,i=`llm_translation_model`,a=`llm_auto_translate`,o=`llm_providers_cache`;function s(e){return e.replace(/\/$/,``)}function c(){let c=t(localStorage.getItem(n)||`http://127.0.0.1:3457`),l=t(localStorage.getItem(r)||``),u=t(localStorage.getItem(i)||``),d=t(localStorage.getItem(a)===`1`),f=t(!1),p=t(null),m=e(()=>s(c.value));function h(){localStorage.setItem(n,c.value),localStorage.setItem(r,l.value),u.value?localStorage.setItem(i,u.value):localStorage.removeItem(i),localStorage.setItem(a,d.value?`1`:`0`)}async function g(e,t={}){let n=`${m.value}${e}`,r={};t.body&&(r[`Content-Type`]=`application/json`);let i=await fetch(n,{...t,headers:{...r,...t.headers}}),a=await i.json();if(!i.ok){let e=a?.message||`请求失败`;throw Error(e)}return a}async function _(){try{let e=await g(`/providers`);return localStorage.setItem(o,JSON.stringify(e)),e}catch(e){let t=localStorage.getItem(o);if(t)return JSON.parse(t);throw e}}async function v(){try{return await g(`/api/config-sync`,{method:`GET`})}catch(e){throw console.error(`配置同步失败:`,e),e}}async function y(e){let t=e.enabled===!1;return await g(`/api/providers/enabled`,{method:`POST`,body:JSON.stringify({name:e.name,enabled:t})}),await v().catch(e=>{console.warn(`配置同步失败，但不影响操作:`,e)}),t}async function b(e){await g(`/providers/${e}`,{method:`DELETE`}),await v().catch(e=>{console.warn(`配置同步失败，但不影响操作:`,e)})}async function x(e,t,n=!1){let r={type:e.type||`openai`,id:e.name,...e};t?await g(`/providers/${e.name}`,{method:`PUT`,body:JSON.stringify(r)}):await g(`/providers`,{method:`POST`,body:JSON.stringify({...r,model:`dummy`})}),n||await v().catch(e=>{console.warn(`配置同步失败，但不影响操作:`,e)})}async function S(e){let t=new Set((await _()).map(e=>e.name)),n=new Set(e.map(e=>e.name));for(let e of t)n.has(e)||await g(`/providers/${e}`,{method:`DELETE`});for(let n of e)await x(n,t.has(n.name),!0);await v().catch(e=>{console.warn(`配置同步失败，但不影响操作:`,e)})}async function C(e=60,t=500){for(let n=0;n<e;n++)try{return await g(`/health`),!0}catch{await new Promise(e=>setTimeout(e,t))}return!1}async function w(){await g(`/api/restart`,{method:`POST`,body:JSON.stringify({})}),f.value=!1;let e=localStorage.getItem(n);e&&e!==c.value&&(c.value=e),await new Promise(e=>setTimeout(e,1e3)),await C()||console.warn(`服务重启超时，但仍将刷新页面`),window.location.reload()}async function T(){return await g(`/api/config`)}async function E(e){let t=await g(`/api/config`,{method:`POST`,body:JSON.stringify(e)});if(e.HOST!==void 0||e.PORT!==void 0){let t=`http://${e.HOST??`127.0.0.1`}:${e.PORT??3457}`;c.value!==t&&localStorage.setItem(n,t)}if(e.APIKEY!==void 0){let t=String(e.APIKEY||``).trim();l.value!==t&&(l.value=t,localStorage.setItem(r,t))}return t}async function D(){p.value={ok:!1,msg:`连接中...`};try{await g(`/health`),p.value={ok:!0,msg:`服务在线`}}catch(e){p.value={ok:!1,msg:e.message}}}async function O(){let e=await g(`/api/clipboard-watch/status`,{method:`GET`});return{running:!!e.running,pid:e.pid??null}}async function k(){let e=await g(`/api/clipboard-watch/start`,{method:`GET`});return{running:!!e.running,pid:e.pid??null}}async function A(){let e=await g(`/api/clipboard-watch/stop`,{method:`GET`});return{running:!!e.running,pid:e.pid??null}}async function j(){return await g(`/api/logs/files`,{method:`GET`})}async function M(e,t=0,n=1e3){let r=new URLSearchParams({file:e});return t>0&&r.append(`offset`,t.toString()),n>0&&r.append(`size`,Math.min(n,1e4).toString()),await g(`/api/logs?${r.toString()}`,{method:`GET`})}async function N(e){return await g(`/api/logs?file=${encodeURIComponent(e)}`,{method:`DELETE`})}async function P(){return await g(`/api/statusline/update`,{method:`GET`})}async function F(e){return await g(`/api/claude/start`,{method:`POST`,body:JSON.stringify(e)})}async function I(e=100,t=0){return await g(`/api/messages?${new URLSearchParams({limit:e.toString(),offset:t.toString()}).toString()}`)}async function L(e){return await g(`/api/messages/${e}`)}async function R(e){return await g(`/api/messages`,{method:`DELETE`,body:JSON.stringify({requestIds:Array.isArray(e)?e:[e]})})}async function z(e){return(await g(`/api/mcp/servers/${encodeURIComponent(e)}/tools`,{method:`GET`})).tools||[]}async function B(e){return(await g(`/api/mcp/servers/${encodeURIComponent(e)}/tools/refresh`,{method:`POST`})).tools||[]}async function V(){try{return(await g(`/api/transformers`)).transformers||[]}catch(e){return console.error(`获取 transformers 失败:`,e),[]}}async function H(e,t,n,r){let i={};n&&(i.Authorization=`Bearer ${n}`);let a=await g(`/v1/messages`,{method:`POST`,headers:i,body:JSON.stringify({messages:e,model:t,stream:!1,apiKey:r?.trim()||void 0})}),o=``;return o=a.content&&Array.isArray(a.content)?a.content.map(e=>e.text||``).join(``):a.choices?.[0]?.message?.content?a.choices[0].message.content:a.message?a.message??``:JSON.stringify(a),{role:`assistant`,content:o}}async function U(e,t,n,r,i){let a={};n&&(a.Authorization=`Bearer ${n}`);let o=`${m.value}/v1/messages`,s;try{s=await fetch(o,{method:`POST`,headers:{"Content-Type":`application/json`,...a},body:JSON.stringify({messages:e,model:t,stream:!0,apiKey:i?.trim()||void 0})})}catch(e){let t=e instanceof Error?e.message:`网络请求失败，请检查网络连接或服务器是否正常运行`;throw Error(t)}if(!s.ok){let e=`请求失败 (${s.status})`;try{let t=await s.json().catch(()=>({}));e=t?.message??t?.error??e}catch{let t=await s.text().catch(()=>``);t&&(e=t.substring(0,200))}if(typeof e==`object`)try{e=JSON.stringify(e)}catch{e=`[object Object]`}throw Error(String(e))}let c=s.headers.get(`Content-Type`)||``;if(!c.includes(`text/event-stream`)&&!c.includes(`stream`))try{let e=await s.json();if(e.content&&Array.isArray(e.content)){r(e.content.map(e=>e.text||``).join(``));return}}catch{}if(!s.body)throw Error(`响应体为空`);let l=s.body.getReader(),u=new TextDecoder,d=``,f=``;try{for(;;){let{done:e,value:t}=await l.read();if(e)break;d+=u.decode(t,{stream:!0});let n=d.split(`
`);d=n.pop()||``;for(let e of n){if(!e.trim())continue;let t=e.trim();if(!t.startsWith(`event: `)&&(t.startsWith(`data: `)&&(t=t.substring(6).trim()),!(t.startsWith(`:`)||t===`[DONE]`)&&t))try{let e=JSON.parse(t);if(e.type===`content_block_delta`&&e.delta?.text)f+=e.delta.text,r(f);else if(e.type===`content_block_delta`&&e.delta?.type===`text_delta`&&e.delta.text)f+=e.delta.text,r(f);else if(e.type===`message_delta`&&e.delta?.text)f+=e.delta.text,r(f);else if(e.choices?.[0]?.delta?.content){let t=e.choices[0].delta.content;t&&(f+=t,r(f))}else if(e.choices?.[0]?.delta?.message?.content){let t=e.choices[0].delta.message.content;t&&(f+=t,r(f))}else if(typeof e.content==`string`)f=e.content,r(f);else if(e.delta?.text)f+=e.delta.text,r(f);else if(e.choices?.[0]?.finish_reason)continue}catch{}}}}catch(e){let t=e instanceof Error?e.message:`流式读取失败`;throw Error(`流式响应处理失败: ${t}`)}finally{try{l.releaseLock()}catch{}}}return{baseUrl:c,tempApiKey:l,translationModel:u,autoTranslate:d,needsRestart:f,healthStatus:p,endpoint:m,persistSettings:h,fetchProviders:_,toggleProvider:y,deleteProvider:b,saveProvider:x,saveProvidersJson:S,syncConfig:v,restartService:w,fetchConfig:T,saveConfig:E,checkHealth:D,fetchClipboardWatchStatus:O,startClipboardWatch:k,stopClipboardWatch:A,fetchLogFiles:j,fetchLogs:M,clearLogs:N,sendMessage:H,sendMessageStream:U,updateStatusLine:P,startClaudeCli:F,fetchMessages:I,fetchMessageDetail:L,deleteMessages:R,fetchMcpServerTools:z,refreshMcpServerTools:B,fetchTransformers:V}}export{c as t};